---
title: JVM-Java中的类加载机制
toc: true
categories:
  - Java
  - JVM
tags:
  - java
  - jvm
abbrlink: 5e4eb5a4
date: 2019-09-12 07:20:04
---

在正式了解 Java 类加载机制的细节之前，我们有必要了解一下 JVM 整体的运行原理，对 JVM 运行机制的整体脉络进行一次梳理。

![JVM 整体运行原理](http://image.shuiyujie.com/2019-09-12-07-30-00.png)

首先我们会有一系列以 `.java` 结尾的源文件。要把这些源文件发布到线上，我们需要将其打成 jar 包，或者打成 war 包。这个打包的过程就是将 `.java` 文件**编译**成 `.class` 文件。接着就可以使用 Tomcat 这样的容器，或者 java 命令来运行一个 jar 包中的文件。

这里有一个问题，**编译好的 `.class` 字节码是怎么运行起来的呢？**

<!-- more -->

# JVM 在什么情况下会加载一个类？

JVM 会通过[类加载器](https://shuiyujie.com/post/5b2f68e0.html)来加载一个类，然后将类保存到内存中，并执行代码。一个类从加载到使用，一般会经历下面这样一个过程：

![Java类加载过程](http://image.shuiyujie.com/2019-09-12-10-15-05.png)

**那么什么时候 JVM 会使用类加载器去加载一个类呢？**答案很简单，就是在使用这个类的时候。

举例来说，如果有下面这样一段代码

```java
public class Application {
	public static void main(){
    MyConfig config = new MyConfig();
  }
}
```

Application 类中有一个 `main()` 函数，`main()` 作为程序的入口一定会在 JVM 进行启动之后被加载到内存中。之后开始执行 `main()` 中的方法，遇到别的类就将这个类加载到内存中，情况如图所示：

![JVM 什么时候加载一个类？](http://image.shuiyujie.com/2019-09-12-09-39-44.png)



# 验证、准备和解析的过程

- 验证阶段：验证 `.class` 文件是否符合 *Java 虚拟机规范*。这点比较容易理解，就像我们使用数据之前要先校验一下。
- 准备阶段：给加载到的类分配内存空间，比如说 `MyConfig` 类中有类变量，就要给它分配内存空间，给一个初始值。
- 解析阶段：将符号引用替换为直接引用

![验证、准备和解析的过程](http://image.shuiyujie.com/2019-09-12-09-49-41.png)

验证、准备和解析可以合称为**准备阶段**。在准备阶段，JVM 为加载进来的类分配了内存空间，为类变量分配了内存空间，并给类变量赋了初值。接下来的初始化阶段，就会正式执行类初始化的代码了。

# 核心阶段：初始化

前面说了，在准备阶段，JVM 会给类分配内存，会给类变量分配内存并赋予初值。在初始化阶段，则会正式执行类初始化代码。

**什么叫正式执行初始化代码呢？**来看下面这样一段代码

![初始化阶段举例](http://image.shuiyujie.com/2019-09-12-10-03-47.png)

*准备阶段*会为类变量 `flushInterval ` 分配内存空间，并且将其初值赋为 0。在*初始化阶段*，`flushInterval` 执行赋值语句，获取一个配置参数。

此外，初始化阶段还会执行静态代码块，本例中完成数据的加载工作。

**什么时候会初始化一个类呢？**

1. new 一个实例化的对象，将会出发类加载到初始化的全过程，将这个类准备好，再实例化一个对象处理
2. 包含 `main()` 的主类，将会立即初始化
3. 初始化一个类的时候，如果其父类还未初始化，就必须先初始化他的父类

![Java 类加载过程](http://image.shuiyujie.com/2019-09-12-10-13-49.png)

