<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>【darknet】darknet实战 - 深页</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="Darknet is an open source neural network framework written in C and CUDA. It is fast, easy to install, and supports CPU and GPU computation. —— https://pjreddie.com/darknet/  本文是对使用 darknet 进行目标检测的小">
<meta name="keywords" content="deeplearning,开源框架,darknet">
<meta property="og:type" content="article">
<meta property="og:title" content="【darknet】darknet实战">
<meta property="og:url" content="http://shuiyujie.com/post/5ba44047.html">
<meta property="og:site_name" content="深页">
<meta property="og:description" content="Darknet is an open source neural network framework written in C and CUDA. It is fast, easy to install, and supports CPU and GPU computation. —— https://pjreddie.com/darknet/  本文是对使用 darknet 进行目标检测的小">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://image.shuiyujie.com/2019-06-13-21-01-25.png">
<meta property="og:image" content="http://image.shuiyujie.com/2019-06-04-22-23-29.png">
<meta property="og:image" content="http://image.shuiyujie.com/labelimg.png">
<meta property="og:image" content="http://shuiyujie.com/Users/shui/Desktop/yolov3_darknet/images/loss.png">
<meta property="og:updated_time" content="2019-06-19T14:20:29.174Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【darknet】darknet实战">
<meta name="twitter:description" content="Darknet is an open source neural network framework written in C and CUDA. It is fast, easy to install, and supports CPU and GPU computation. —— https://pjreddie.com/darknet/  本文是对使用 darknet 进行目标检测的小">
<meta name="twitter:image" content="http://image.shuiyujie.com/2019-06-13-21-01-25.png">





<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="【darknet】darknet实战" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="/tags">Tags</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-06-13T13:09:45.000Z">2019-06-13</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/DeepLearning/">DeepLearning</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 10548 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                【darknet】darknet实战
            
        </h1>
        <div class="content">
            <p><img src="http://image.shuiyujie.com/2019-06-13-21-01-25.png" alt="darknet"></p>
<blockquote>
<p>Darknet is an open source neural network framework written in C and CUDA. It is fast, easy to install, and supports CPU and GPU computation.</p>
<p>—— <a href="https://pjreddie.com/darknet/" target="_blank" rel="noopener">https://pjreddie.com/darknet/</a></p>
</blockquote>
<p>本文是对使用 darknet 进行目标检测的小结，包括：</p>
<ol>
<li>数据集准备：如何使用 labelimage 对数据进行标注，注意事项，文件格式转换</li>
<li>darknet 使用：如何编译和修改配置文件</li>
<li>模型评估：如何查看 loss、计算 IoU、recall、mAP</li>
</ol>
<a id="more"></a>
<h1 id="数据集准备"><a href="#数据集准备" class="headerlink" title="数据集准备"></a>数据集准备</h1><p><img src="http://image.shuiyujie.com/2019-06-04-22-23-29.png" alt="如图"></p>
<p>大多数情况下，数据集决定了任务的成败。一开始我认为标注数据是一件非常枯燥和乏味的事情，但是当模型指标一直上不去，检测和识别效果也一直不好时，回过头才会发现是因为数据标注的有问题。</p>
<p>这只有自己经历过之后才会有体会，得出这样几条经验：</p>
<ol>
<li>保持类间差距大，类内差距小</li>
<li>一开始先标注少量的图片并训练模型查看效果，根据结果进行调整，否则等到标注了大量图片之后再回过头修改，得不偿失。</li>
</ol>
<h2 id="labelimage"><a href="#labelimage" class="headerlink" title="labelimage"></a>labelimage</h2><p>图片标注使用的是开源的工具 <a href="https://github.com/tzutalin/labelImg" target="_blank" rel="noopener">LabelImg</a>，可以查看文档自行编译，下载之后的文件结构如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── build-tools</span><br><span class="line">├── CONTRIBUTING.rst</span><br><span class="line">├── data</span><br><span class="line">    |—— predefined_classes.txt</span><br><span class="line">├── labelImg.py</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>data/predefined_classes.txt</code>文件配置进行图片的类别</li>
</ul>
<h2 id="界面展示及注意事项"><a href="#界面展示及注意事项" class="headerlink" title="界面展示及注意事项"></a>界面展示及注意事项</h2><p>启动 labelimg 之后的界面如下图所示</p>
<p><img src="http://image.shuiyujie.com/labelimg.png" alt="labelimg 界面"></p>
<p>注意：</p>
<ol>
<li>存放图片文件夹和存放标记文件的文件夹需要保持一致</li>
<li>正确选择标记文件的格式，是需要 yolo 格式还是 xml 格式，默认为 xml 格式</li>
<li>右侧可以选择默认标签，当密集标注一个类的时候很实用</li>
<li>打完几张标签之后请确认标签是否正确，再去文件目录下确认以下标记文件是否生成且格式正确</li>
</ol>
<h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+------------+--------------------------------------------+</span><br><span class="line">| Space      | 保存                                        |</span><br><span class="line">+------------+--------------------------------------------+</span><br><span class="line">| w          | 创建矩形框                                   |</span><br><span class="line">+------------+--------------------------------------------+</span><br><span class="line">| d          | 下一张图片                                   |</span><br><span class="line">+------------+--------------------------------------------+</span><br><span class="line">| a          | 上一张图片                                   |</span><br><span class="line">+------------+--------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>最常用的快捷键是上面这 4 个，用好快捷键可以调高打标效率。此外按住<code>ctrl+鼠标滚轮</code>可以调整图片大小，局部放大图片可以提高打标的精准度。</p>
<h2 id="yolo格式和-xml-格式转换"><a href="#yolo格式和-xml-格式转换" class="headerlink" title="yolo格式和 xml 格式转换"></a>yolo格式和 xml 格式转换</h2><h3 id="xml2yolo-py"><a href="#xml2yolo-py" class="headerlink" title="xml2yolo.py"></a>xml2yolo.py</h3><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-string">1. 修改 classes 列表中的元素为当前标签列表</span></span><br><span class="line"><span class="hljs-string">2. 修改 list_xml 指向的 xml 文件保存的位置</span></span><br><span class="line"><span class="hljs-string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#import xml.etree.ElementTree as ET</span></span><br><span class="line"><span class="hljs-keyword">from</span> xml.etree <span class="hljs-keyword">import</span> ElementTree <span class="hljs-keyword">as</span> ET</span><br><span class="line"><span class="hljs-keyword">import</span> pickle</span><br><span class="line"><span class="hljs-keyword">import</span> os</span><br><span class="line"><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> listdir, getcwd</span><br><span class="line"><span class="hljs-keyword">from</span> os.path <span class="hljs-keyword">import</span> join</span><br><span class="line"><span class="hljs-keyword">import</span> glob</span><br><span class="line"></span><br><span class="line">classes = [<span class="hljs-string">'rabbit'</span>]</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert</span><span class="hljs-params">(size, box)</span>:</span></span><br><span class="line">      dw = <span class="hljs-number">1.</span> / (size[<span class="hljs-number">0</span>])</span><br><span class="line">      dh = <span class="hljs-number">1.</span> / (size[<span class="hljs-number">1</span>])</span><br><span class="line">      x = (box[<span class="hljs-number">0</span>] + box[<span class="hljs-number">1</span>]) / <span class="hljs-number">2.0</span> - <span class="hljs-number">1</span></span><br><span class="line">      y = (box[<span class="hljs-number">2</span>] + box[<span class="hljs-number">3</span>]) / <span class="hljs-number">2.0</span> - <span class="hljs-number">1</span></span><br><span class="line">      w = box[<span class="hljs-number">1</span>] - box[<span class="hljs-number">0</span>]</span><br><span class="line">      h = box[<span class="hljs-number">3</span>] - box[<span class="hljs-number">2</span>]</span><br><span class="line">      x = x * dw</span><br><span class="line">      w = w * dw</span><br><span class="line">      y = y * dh</span><br><span class="line">      h = h * dh</span><br><span class="line">      <span class="hljs-keyword">return</span> (x, y, w, h)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_annotation</span><span class="hljs-params">(xml_file, txt_file)</span>:</span></span><br><span class="line">      in_file = open(xml_file)</span><br><span class="line"></span><br><span class="line">      tree = ET.parse(in_file)</span><br><span class="line">      root = tree.getroot()</span><br><span class="line">      size = root.find(<span class="hljs-string">'size'</span>)</span><br><span class="line">      w = int(size.find(<span class="hljs-string">'width'</span>).text)</span><br><span class="line">      h = int(size.find(<span class="hljs-string">'height'</span>).text)</span><br><span class="line"></span><br><span class="line">      <span class="hljs-keyword">for</span> obj <span class="hljs-keyword">in</span> root.iter(<span class="hljs-string">'object'</span>):</span><br><span class="line"></span><br><span class="line">            cls = obj.find(<span class="hljs-string">'name'</span>).text</span><br><span class="line">            <span class="hljs-keyword">if</span> cls <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> classes:</span><br><span class="line">                  <span class="hljs-keyword">continue</span></span><br><span class="line">            cls_id = classes.index(cls)</span><br><span class="line">            xmlbox = obj.find(<span class="hljs-string">'bndbox'</span>)</span><br><span class="line">            b = (float(xmlbox.find(<span class="hljs-string">'xmin'</span>).text), float(xmlbox.find(<span class="hljs-string">'xmax'</span>).text), float(xmlbox.find(<span class="hljs-string">'ymin'</span>).text),</span><br><span class="line">                 float(xmlbox.find(<span class="hljs-string">'ymax'</span>).text))</span><br><span class="line">            bb = convert((w, h), b)</span><br><span class="line">            txt_file.write(str(cls_id) + <span class="hljs-string">" "</span> + <span class="hljs-string">" "</span>.join([str(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> bb]) + <span class="hljs-string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">list_xml = []</span><br><span class="line">list_xml = glob.glob(<span class="hljs-string">r"/file_path/*.xml"</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> xml_file <span class="hljs-keyword">in</span> list_xml:</span><br><span class="line">      xml_name = xml_file.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>]</span><br><span class="line">      txt_file = open(<span class="hljs-string">'%s.txt'</span> % (xml_name), <span class="hljs-string">'w'</span>)</span><br><span class="line">      convert_annotation(xml_file, txt_file)</span><br><span class="line">      txt_file.close()</span><br></pre></td></tr></table></figure>
<h3 id="yolo2xml-py"><a href="#yolo2xml-py" class="headerlink" title="yolo2xml.py"></a>yolo2xml.py</h3><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-string">1. 修改 class_name</span></span><br><span class="line"><span class="hljs-string">2. 修改 src_img_dir/src_txt_dir/src_xml_dir 路径</span></span><br><span class="line"><span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-keyword">import</span> os, sys</span><br><span class="line"><span class="hljs-keyword">import</span> glob</span><br><span class="line"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">class_name = [<span class="hljs-string">'switch_closed'</span>,<span class="hljs-string">'switch_open'</span>,<span class="hljs-string">'whirled_switch_closed'</span>,<span class="hljs-string">'whirled_switch_open'</span>,</span><br><span class="line">        <span class="hljs-string">'lifting_switch_closed'</span>,<span class="hljs-string">'lifting_switch_open'</span>,<span class="hljs-string">'closure_switch_closed'</span>,<span class="hljs-string">'closure_switch_open'</span>,</span><br><span class="line">        <span class="hljs-string">'color_switch01_red'</span>,<span class="hljs-string">'color_switch01_green'</span>,<span class="hljs-string">'color_switch02_red'</span>,<span class="hljs-string">'color_switch02_green'</span>,</span><br><span class="line">        <span class="hljs-string">'isolation_switch_closed'</span>,<span class="hljs-string">'isolation_switch_open'</span>,<span class="hljs-string">'grounding_knife_switch01_closed'</span>,<span class="hljs-string">'grounding_knife_switch01_open'</span>,</span><br><span class="line">        <span class="hljs-string">'grounding_knife_switch02_closed'</span>,<span class="hljs-string">'grounding_knife_switch02_open'</span>]</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_yolo_coordinates_to_voc</span><span class="hljs-params">(x_c_n, y_c_n, width_n, height_n, img_width, img_height)</span>:</span></span><br><span class="line">  <span class="hljs-comment">## remove normalization given the size of the image</span></span><br><span class="line">  x_c = float(x_c_n) * img_width</span><br><span class="line">  y_c = float(y_c_n) * img_height</span><br><span class="line">  width = float(width_n) * img_width</span><br><span class="line">  height = float(height_n) * img_height</span><br><span class="line">  <span class="hljs-comment">## compute half width and half height</span></span><br><span class="line">  half_width = width / <span class="hljs-number">2</span></span><br><span class="line">  half_height = height / <span class="hljs-number">2</span></span><br><span class="line">  <span class="hljs-comment">## compute left, top, right, bottom</span></span><br><span class="line">  <span class="hljs-comment">## in the official VOC challenge the top-left pixel in the image has coordinates (1;1)</span></span><br><span class="line">  left = int(x_c - half_width) + <span class="hljs-number">1</span></span><br><span class="line">  top = int(y_c - half_height) + <span class="hljs-number">1</span></span><br><span class="line">  right = int(x_c + half_width) + <span class="hljs-number">1</span></span><br><span class="line">  bottom = int(y_c + half_height) + <span class="hljs-number">1</span></span><br><span class="line">  <span class="hljs-keyword">return</span> left, top, right, bottom</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#  将标注的txt转换为 voc xml</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># VEDAI 图像存储位置</span></span><br><span class="line">src_img_dir = <span class="hljs-string">"./switch_mAP"</span></span><br><span class="line"><span class="hljs-comment"># VEDAI 图像的 ground truth 的 txt 文件存放位置</span></span><br><span class="line">src_txt_dir = <span class="hljs-string">"./switch_mAP"</span></span><br><span class="line">src_xml_dir = <span class="hljs-string">"./switch_mAP"</span></span><br><span class="line"></span><br><span class="line">img_Lists = glob.glob(src_img_dir + <span class="hljs-string">'/*.txt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 文件名(含扩展名)</span></span><br><span class="line">img_basenames = []  <span class="hljs-comment"># e.g. 100</span></span><br><span class="line"><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> img_Lists:</span><br><span class="line">      img_basenames.append(os.path.basename(item))</span><br><span class="line"></span><br><span class="line">img_names = []  <span class="hljs-comment"># e.g. 100</span></span><br><span class="line"><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> img_basenames:</span><br><span class="line">      <span class="hljs-comment"># 文件名与扩展名</span></span><br><span class="line">      temp1, temp2 = os.path.splitext(item)</span><br><span class="line">      img_names.append(temp1)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> img <span class="hljs-keyword">in</span> img_names:</span><br><span class="line">      </span><br><span class="line">      im = <span class="hljs-string">""</span></span><br><span class="line">      suffix = <span class="hljs-string">""</span></span><br><span class="line">      <span class="hljs-comment"># 同一个文件夹下存在多种图片格式，在这里加上格式判断</span></span><br><span class="line">      <span class="hljs-keyword">if</span> os.path.exists(src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.jpg'</span>):</span><br><span class="line">            im = Image.open((src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.jpg'</span>))</span><br><span class="line">            suffix = <span class="hljs-string">'.jpg'</span></span><br><span class="line">      <span class="hljs-keyword">elif</span> os.path.exists(src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.JPG'</span>):</span><br><span class="line">            im = Image.open((src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.JPG'</span>))</span><br><span class="line">            suffix = <span class="hljs-string">'.JPG'</span></span><br><span class="line">      <span class="hljs-keyword">elif</span> os.path.exists(src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.png'</span>):</span><br><span class="line">            im = Image.open((src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.png'</span>))</span><br><span class="line">            suffix = <span class="hljs-string">'.png'</span></span><br><span class="line">      <span class="hljs-keyword">elif</span> os.path.exists(src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.PNG'</span>):</span><br><span class="line">            im = Image.open((src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.PNG'</span>))</span><br><span class="line">            suffix = <span class="hljs-string">'.PNG'</span></span><br><span class="line">      <span class="hljs-keyword">elif</span> os.path.exists(src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.JPEG'</span>):</span><br><span class="line">            im = Image.open((src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.JPEG'</span>))</span><br><span class="line">            suffix = <span class="hljs-string">'.JPEG'</span></span><br><span class="line">      <span class="hljs-keyword">elif</span> os.path.exists(src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.jpeg'</span>):</span><br><span class="line">            im = Image.open((src_img_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.jpeg'</span>))</span><br><span class="line">            suffix = <span class="hljs-string">'.jpeg'</span></span><br><span class="line">                  </span><br><span class="line">      width, height = im.size</span><br><span class="line"></span><br><span class="line">      <span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-string">      以下部分为 xml 解析</span></span><br><span class="line"><span class="hljs-string">      """</span></span><br><span class="line"></span><br><span class="line">      <span class="hljs-comment"># open the crospronding txt file</span></span><br><span class="line">      <span class="hljs-comment">#  提取每一行并分割</span></span><br><span class="line">      gt = open(src_txt_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.txt'</span>).read().splitlines()</span><br><span class="line"></span><br><span class="line">      print(img + <span class="hljs-string">'\n'</span>)</span><br><span class="line">      <span class="hljs-comment"># write in xml file</span></span><br><span class="line">      <span class="hljs-comment"># os.mknod(src_xml_dir + '/' + img + '.xml')</span></span><br><span class="line">      xml_file = open((src_xml_dir + <span class="hljs-string">'/'</span> + img + <span class="hljs-string">'.xml'</span>), <span class="hljs-string">'a'</span>)</span><br><span class="line">      xml_file.write(<span class="hljs-string">'&lt;annotation&gt;\n'</span>)</span><br><span class="line">      xml_file.write(<span class="hljs-string">'    &lt;folder&gt;VOC2007&lt;/folder&gt;\n'</span>)</span><br><span class="line">      xml_file.write(<span class="hljs-string">'    &lt;filename&gt;'</span> + str(img) + suffix + <span class="hljs-string">'&lt;/filename&gt;\n'</span>)</span><br><span class="line">      xml_file.write(<span class="hljs-string">'    &lt;size&gt;\n'</span>)</span><br><span class="line">      xml_file.write(<span class="hljs-string">'        &lt;width&gt;'</span> + str(width) + <span class="hljs-string">'&lt;/width&gt;\n'</span>)</span><br><span class="line">      xml_file.write(<span class="hljs-string">'        &lt;height&gt;'</span> + str(height) + <span class="hljs-string">'&lt;/height&gt;\n'</span>)</span><br><span class="line">      xml_file.write(<span class="hljs-string">'        &lt;depth&gt;3&lt;/depth&gt;\n'</span>)</span><br><span class="line">      xml_file.write(<span class="hljs-string">'    &lt;/size&gt;\n'</span>)</span><br><span class="line"></span><br><span class="line">      <span class="hljs-comment"># write the region of image on xml file</span></span><br><span class="line">      <span class="hljs-keyword">for</span> img_each_label <span class="hljs-keyword">in</span> gt:</span><br><span class="line">            spt = img_each_label.split(<span class="hljs-string">' '</span>)  <span class="hljs-comment"># 这里如果txt里面是以逗号‘，’隔开的，那么就改为spt = img_each_label.split(',')。</span></span><br><span class="line"></span><br><span class="line">            name = class_name[int(spt[<span class="hljs-number">0</span>])]</span><br><span class="line">            x_c,y_c,width_n,height_n = spt[<span class="hljs-number">1</span>:]</span><br><span class="line">            xmin,ymin,xmax,ymax = convert_yolo_coordinates_to_voc(x_c,y_c,width_n,height_n,width,height)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            xml_file.write(<span class="hljs-string">'    &lt;object&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'        &lt;name&gt;'</span> + name + <span class="hljs-string">'&lt;/name&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'        &lt;pose&gt;Unspecified&lt;/pose&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'        &lt;truncated&gt;0&lt;/truncated&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'        &lt;difficult&gt;0&lt;/difficult&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'        &lt;bndbox&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'            &lt;xmin&gt;'</span> + str(xmin) + <span class="hljs-string">'&lt;/xmin&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'            &lt;ymin&gt;'</span> + str(ymin) + <span class="hljs-string">'&lt;/ymin&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'            &lt;xmax&gt;'</span> + str(xmax) + <span class="hljs-string">'&lt;/xmax&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'            &lt;ymax&gt;'</span> + str(ymax) + <span class="hljs-string">'&lt;/ymax&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'        &lt;/bndbox&gt;\n'</span>)</span><br><span class="line">            xml_file.write(<span class="hljs-string">'    &lt;/object&gt;\n'</span>)</span><br><span class="line"></span><br><span class="line">      xml_file.write(<span class="hljs-string">'&lt;/annotation&gt;'</span>)</span><br></pre></td></tr></table></figure>
<h1 id="使用-darknet-训练模型"><a href="#使用-darknet-训练模型" class="headerlink" title="使用 darknet 训练模型"></a>使用 darknet 训练模型</h1><h2 id="安装和编译"><a href="#安装和编译" class="headerlink" title="安装和编译"></a>安装和编译</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 从 Github 下载</span><br><span class="line">git clone https://github.com/pjreddie/darknet</span><br></pre></td></tr></table></figure>
<p>进入<code>darknet</code>目录中，对编译文件<code>Makefile</code>进行如下修改</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GPU=1</span><br><span class="line">CUDNN=1</span><br><span class="line">OPENCV=0</span><br><span class="line">OPENMP=0</span><br><span class="line">DEBUG=0</span><br></pre></td></tr></table></figure>
<p>注:</p>
<ol>
<li>画图或显示图片等操作需要配置OPENCV并设置为1</li>
<li>需要多线程相关操作需要将OPENMP设置为1</li>
</ol>
<p>修改完成保存并执行<code>make</code>命令。</p>
<h2 id="目录结构介绍"><a href="#目录结构介绍" class="headerlink" title="目录结构介绍"></a>目录结构介绍</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── backup</span><br><span class="line">├── cfg</span><br><span class="line">    |—— voc.data</span><br><span class="line">    |—— yolov3-voc.cfg</span><br><span class="line">├── darknet</span><br><span class="line">├── data</span><br><span class="line">    |—— voc.names</span><br><span class="line">		|—— train.txt</span><br><span class="line">    |—— val.txt</span><br><span class="line">    |—— test.txt</span><br><span class="line">├── scripts</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>编译完成之后，我们关注目录中的这几个文件和文件夹。</p>
<ol>
<li>backup 存放训练出来的权值文件</li>
<li>cfg 保存配置文件，其中两个文件，在后面介绍</li>
<li>darknet 是可执行文件</li>
<li>scripts 下是一些脚本</li>
<li>data/voc.names 存放类别标签 </li>
<li>train.txt 保存用于训练的图片全路径(自建，位置无特殊要求)</li>
<li>val.txt 保存用于校正的图片全路径(自建，位置无特殊要求)</li>
<li>test.txt 保存用于校正的图片全路径(自建，位置无特殊要求)</li>
</ol>
<p><em>注: train.txt, val.txt, test.txt 中图片数量比例建议为 8:1:1</em></p>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><h3 id="类别文件-voc-names"><a href="#类别文件-voc-names" class="headerlink" title="类别文件 voc.names"></a>类别文件 voc.names</h3><p>修改<code>data/voc.names</code>，将我们的类别标签写这个文件，比如说有以下 5 类</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dog</span><br><span class="line">cat</span><br><span class="line">magpie</span><br><span class="line">pigeon</span><br><span class="line">nest</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ol>
<li>类别标签要与训练集包含的图片类别一一对应，训练集中有以上 5 类则<code>voc.names</code>包含以上 5 类</li>
<li>类别标签需要连续，如果不连续就必须要修改类别标签改成连续的</li>
</ol>
<h3 id="配置-voc-data"><a href="#配置-voc-data" class="headerlink" title="配置 voc.data"></a>配置 voc.data</h3><p>修改<code>cfg/voc.data</code>文件</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">classes= class_number</span><br><span class="line">train  = /path/train.txt</span><br><span class="line">valid  = /path/val.txt</span><br><span class="line">names = data/voc.names</span><br><span class="line">backup = backup</span><br></pre></td></tr></table></figure>
<ol>
<li>classes 配置类别数量，与上一步<code>voc.names</code>中类别数量一致</li>
<li>train 配置为目录结构一章介绍的<code>train.txt</code>文件的位置</li>
<li>vaild 配置为目录结构一章介绍的<code>val.txt</code>文件的位置</li>
<li>names 配置为<code>voc.names</code>位置(默认不变即可)</li>
<li>backup 配置为权值文件的位置(默认不变即可)</li>
</ol>
<h3 id="配置-yolov3-voc-cfg"><a href="#配置-yolov3-voc-cfg" class="headerlink" title="配置 yolov3-voc.cfg"></a>配置 yolov3-voc.cfg</h3><p>在文件开头位置</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[net]</span><br><span class="line"># Testing</span><br><span class="line"># batch=1 # 测试时开启，训练时关闭</span><br><span class="line"># subdivisions=1 # 测试时开启，训练时关闭</span><br><span class="line"># Training</span><br><span class="line">batch=6 # 训练时开启，测试时关闭</span><br><span class="line">subdivisions=2 # 训练时开启，测试时关闭 </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">learning_rate=0.0001 # 学习率，可以调整得小一点</span><br><span class="line">burn_in=1000</span><br><span class="line">max_batches = 50200</span><br><span class="line">policy=steps</span><br><span class="line">steps=40000,45000</span><br><span class="line">scales=.1,.1</span><br></pre></td></tr></table></figure>
<ol>
<li>batch 和 subdivisions 在测试和训练的时候请按照上面注释开启或者关闭</li>
<li>batch 一批处理几张图片，没有超过显存的情况下越大越好</li>
<li>subdivisions 表示在 batch 中再划分的数量</li>
</ol>
<p>当前配置的意思是每轮迭代从所有训练集中抽取 6 张图片，这 6 张样本图片又被分成 2 次，每次 3 张送入到网络参与训练。</p>
<p>接着在文件中搜索<code>yolo</code>，会有三条结果。每个<code>yolo</code>上下都要修改<code>filters</code>和<code>classes</code>，总共需要修改<strong>3 组共 6 个字段</strong>。</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[convolutional]</span><br><span class="line">size=1</span><br><span class="line">stride=1</span><br><span class="line">pad=1</span><br><span class="line">filters=30 # 3*(classes+5)</span><br><span class="line">activation=linear</span><br><span class="line"></span><br><span class="line">[yolo]</span><br><span class="line">mask = 6,7,8</span><br><span class="line">anchors = 10,13,  16,30,  33,23,  30,61,  62,45,  59,119,  116,90,  156,198,  373,326</span><br><span class="line">classes=5 # 类别(classes)数量</span><br><span class="line">num=9</span><br><span class="line">jitter=.3</span><br><span class="line">ignore_thresh = .5</span><br><span class="line">truth_thresh = 1</span><br><span class="line">random=1</span><br></pre></td></tr></table></figure>
<h2 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./darknet detector train cfg/voc.data cfg/yolov3-voc.cfg scripts/darknet53.conv.74 -gpus 0</span><br></pre></td></tr></table></figure>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./darknet detector train cfg/voc.data cfg/yolov3-voc.cfg scripts/darknet53.conv.74 -gpus 0 &gt;train.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>我们需要保留训练的日志，所以用方法二更好。</p>
<h2 id="查看-GPU-使用情况"><a href="#查看-GPU-使用情况" class="headerlink" title="查看 GPU 使用情况"></a>查看 GPU 使用情况</h2><p>我们可以使用<code>nvidia-smi</code>来查看 gpu 的使用情况，注意先查看 gpu 的使用情况。</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Fri Mar 29 16:33:31 2019       </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 410.78       Driver Version: 410.78       CUDA Version: 10.0     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  GeForce GTX 108...  Off  | 00000000:01:00.0  On |                  N/A |</span><br><span class="line">| 59%   87C    P2   221W / 250W |   4874MiB / 11175MiB |     98%      Default |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line">|   1  GeForce GTX 108...  Off  | 00000000:02:00.0 Off |                  N/A |</span><br><span class="line">| 24%   42C    P8    16W / 250W |   5107MiB / 11178MiB |      0%      Default |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line">                                                                               </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                       GPU Memory |</span><br><span class="line">|  GPU       PID   Type   Process name                             Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0      1218      G   /usr/lib/xorg/Xorg                            69MiB |</span><br><span class="line">|    0     24338      C   ./darknet                                   4793MiB |</span><br><span class="line">|    1     12712      C   ./bin/psd_be                                5095MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>用<code>nvidia-smi</code>输出的是静态的信息，如果想要动态查看 gpu 的使用情况可以使用<code>watch -n 1 nvidia-smi</code>表示每一秒刷新一个 gpu 的使用情况。</p>
<h2 id="查看日志输出信息"><a href="#查看日志输出信息" class="headerlink" title="查看日志输出信息"></a>查看日志输出信息</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">50181: 0.084739, 0.367084 avg, 0.000001 rate, 0.244283 seconds, 301086 images</span><br><span class="line">Loaded: 0.000030 seconds</span><br><span class="line">Region 82 Avg IOU: 0.775331, Class: 0.611054, Obj: 0.963920, No Obj: 0.005009, .5R: 1.000000, .75R: 0.833333,  count: 6</span><br><span class="line">Region 94 Avg IOU: 0.753700, Class: 0.962260, Obj: 0.777823, No Obj: 0.000218, .5R: 1.000000, .75R: 0.500000,  count: 2</span><br></pre></td></tr></table></figure>
<ol>
<li>50181 表示迭代次数</li>
<li>0.084739 表示整体 Loss</li>
<li>0.367084 avg 表示平均 Loss</li>
<li>0.000001 rate 表示学习率，对应<code>.cfg</code>文件中的<code>learning_rate</code></li>
<li>0.244283 seconds 表示当前批次训练花费了多少时间</li>
<li>301086 images 表示目前已经训练了多少照片</li>
</ol>
<p>判断训练没有异常的标准</p>
<ol>
<li>IOU 表示预测目标与真实目标的交集与并集之比，越接近于 1 越好，出现大量 -nan 表示训练异常</li>
<li>Class: 0.611054 表示标记物体的正确率，越接近于 1 越好</li>
<li>Obj: 0.963920 越接近 1 越好</li>
<li>No Obj 0.005009 越接近 0 越好</li>
</ol>
<p>当训练整体趋势按照上面描述的一样向好的方向发展就表示训练正常，反之表示训练异常。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./darknet detector test cfg/voc.data cfg/yolov3-voc.cfg backup/yolov3-voc_50000.weights 1</span><br></pre></td></tr></table></figure>
<p>注意：测试时，修改<code>cfg/yolov3-voc.cfg</code>配置文件，请参照之前<code>配置 yolov3-voc.cfg</code>这一节。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol>
<li>训练集中各个类别的数量要尽可能<strong>保持均衡</strong>，不要有的类特别多或者有的特别少</li>
<li><code>train.txt</code> 文件中配置了训练用的图片，这些图片必须要有对应的<code>txt</code>文件，且<code>txt</code>文件不可以为空</li>
<li><code>train.txt</code> 文件不可以有空行，存在空行会导致训练失败</li>
<li>开始新的训练注意删除<code>backup</code>中原先的<code>.weight</code>文件</li>
</ol>
<h1 id="如何评估模型的效果"><a href="#如何评估模型的效果" class="headerlink" title="如何评估模型的效果"></a>如何评估模型的效果</h1><h2 id="darknet-编译格式"><a href="#darknet-编译格式" class="headerlink" title="darknet 编译格式"></a>darknet 编译格式</h2><figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./darknet detector test &lt;data_cfg&gt; &lt;models_cfg&gt; &lt;weights&gt; &lt;test_file&gt; [-thresh] [-out]</span><br><span class="line">./darknet detector train &lt;data_cfg&gt; &lt;models_cfg&gt; &lt;weights&gt; [-thresh] [-gpu] [-gpus] [-clear]</span><br><span class="line">./darknet detector valid &lt;data_cfg&gt; &lt;models_cfg&gt; &lt;weights&gt; [-out] [-thresh]</span><br><span class="line">./darknet detector recall &lt;data_cfg&gt; &lt;models_cfg&gt; &lt;weights&gt; [-thresh]</span><br><span class="line"></span><br><span class="line">'&lt;&gt;'必选项，’[ ]‘可选项</span><br></pre></td></tr></table></figure>
<ul>
<li>data_cfg：数据配置文件，eg：cfg/voc.data</li>
<li>models_cfg：模型配置文件，eg：cfg/yolov3-voc.cfg</li>
<li>weights：权重配置文件，eg：weights/yolov3.weights</li>
<li>test_file：测试文件，eg：<em>/</em>/*/test.txt</li>
<li>-thresh：显示被检测物体中confidence大于等于 [-thresh] 的bounding-box，默认0.005</li>
<li>-out：输出文件名称，默认路径为results文件夹下，eg：-out “” //输出class_num个文件，文件名为class_name.txt；若不选择此选项，则默认输出文件名为comp4_det_test_”class_name”.txt</li>
<li>-i/-gpu：指定单个gpu，默认为0，eg：-gpu 2</li>
<li>-gpus：指定多个gpu，默认为0，eg：-gpus 0,1,2</li>
</ul>
<h2 id="根据训练日志生成-loss-iter-曲线"><a href="#根据训练日志生成-loss-iter-曲线" class="headerlink" title="根据训练日志生成 loss-iter 曲线"></a>根据训练日志生成 loss-iter 曲线</h2><p>使用 drawcurve.py 解析训练日志，据此生成 loss-iter 曲线。该脚本通过训练日志计算 loss,不过训练日志格式可能会有区别,可能需要自己修改脚本来适应.</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> argparse</span><br><span class="line"><span class="hljs-keyword">import</span> sys</span><br><span class="line"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">(argv)</span>:</span></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="hljs-string">"log_file"</span>,  help = <span class="hljs-string">"path to log file"</span>  )</span><br><span class="line">    parser.add_argument( <span class="hljs-string">"option"</span>, help = <span class="hljs-string">"0 -&gt; loss vs iter"</span>  )</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    f = open(args.log_file)</span><br><span class="line">    lines  = [line.rstrip(<span class="hljs-string">"\n"</span>) <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines()]</span><br><span class="line">    <span class="hljs-comment"># skip the first 3 lines</span></span><br><span class="line">    lines = lines[<span class="hljs-number">3</span>:]</span><br><span class="line">    numbers = &#123;<span class="hljs-string">'1'</span>,<span class="hljs-string">'2'</span>,<span class="hljs-string">'3'</span>,<span class="hljs-string">'4'</span>,<span class="hljs-string">'5'</span>,<span class="hljs-string">'6'</span>,<span class="hljs-string">'7'</span>,<span class="hljs-string">'8'</span>,<span class="hljs-string">'9'</span>, <span class="hljs-string">'0'</span>&#125;</span><br><span class="line">    iters = []</span><br><span class="line">    loss = []</span><br><span class="line">    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:</span><br><span class="line">        print(line)</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment">#跳过空行</span></span><br><span class="line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> len(line):</span><br><span class="line">            <span class="hljs-keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> line[<span class="hljs-number">0</span>] <span class="hljs-keyword">in</span> numbers:</span><br><span class="line">            args = line.split(<span class="hljs-string">" "</span>)</span><br><span class="line">            <span class="hljs-comment"># print(args)</span></span><br><span class="line">            <span class="hljs-keyword">if</span> len(args) &gt; <span class="hljs-number">4</span> <span class="hljs-keyword">and</span> is_number(args[<span class="hljs-number">2</span>]):</span><br><span class="line">                iters.append(int(args[<span class="hljs-number">0</span>][:<span class="hljs-number">-1</span>]))</span><br><span class="line">                loss.append(float(args[<span class="hljs-number">2</span>]))</span><br><span class="line">    plt.plot(iters,loss)</span><br><span class="line">    plt.xlabel(<span class="hljs-string">'iters'</span>)</span><br><span class="line">    plt.ylabel(<span class="hljs-string">'loss'</span>)</span><br><span class="line">    plt.grid()</span><br><span class="line">    plt.show()</span><br><span class="line"><span class="hljs-comment"># 0.692735 seconds, 595200 images</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_number</span><span class="hljs-params">(s)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">try</span>:</span><br><span class="line">        float(s)</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span></span><br><span class="line">    <span class="hljs-keyword">except</span> ValueError:</span><br><span class="line">        <span class="hljs-keyword">pass</span></span><br><span class="line"> </span><br><span class="line">    <span class="hljs-keyword">try</span>:</span><br><span class="line">        <span class="hljs-keyword">import</span> unicodedata</span><br><span class="line">        unicodedata.numeric(s)</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">True</span></span><br><span class="line">    <span class="hljs-keyword">except</span> (TypeError, ValueError):</span><br><span class="line">        <span class="hljs-keyword">pass</span></span><br><span class="line"> </span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>
<p><img src="/Users/shui/Desktop/yolov3_darknet/images/loss.png" alt="loss 曲线"></p>
<h2 id="生成预测结果"><a href="#生成预测结果" class="headerlink" title="生成预测结果"></a>生成预测结果</h2><p>通过<code>./darknet detector valid &lt;data_cfg&gt; &lt;models_cfg&gt; &lt;weights&gt;</code> 可以批量生成模型的测试结果,测试结果保存在<code>results</code>目录下面,按照类别分成一个个文件.</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash">!/bin/bash</span></span><br><span class="line">./darknet detector valid switch_18/switch.data switch_18/switch.cfg switch_18/switch.weights -i 1 -out ""</span><br></pre></td></tr></table></figure>
<ul>
<li>结果生成在 &lt;data_cfg&gt; 的指定的目录下以 &lt;out_file&gt; 开头的若干文件中，若&lt;data_cfg&gt;没有指定results，那么默认为&lt;darknet_root&gt;/results；</li>
<li>&lt;models_cfg&gt; 文件中 batch 和 subdivisions 两项必须为1；</li>
<li>若 -out 未指定字符串，则在 results 文件夹下生成 comp4_det_test_[类名].txt 文件并保存测试结果；</li>
<li>本次实验在 results 文件夹下生成  [类名].txt 文件；</li>
</ul>
<h2 id="统计召回率-recall"><a href="#统计召回率-recall" class="headerlink" title="统计召回率 recall"></a>统计召回率 recall</h2><figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash">!/bin/bash</span></span><br><span class="line">./darknet detector recall switch_18/switch.data switch_18/switch.cfg switch_18/switch.weights</span><br></pre></td></tr></table></figure>
<p>输出结果为</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">835    35    45	RPs/Img: 1.81	IOU: 57.69%	Recall:77.78%</span><br><span class="line">836    35    45	RPs/Img: 1.81	IOU: 57.69%	Recall:77.78%</span><br><span class="line">837    35    45	RPs/Img: 1.81	IOU: 57.69%	Recall:77.78%</span><br><span class="line">838    35    45	RPs/Img: 1.81	IOU: 57.69%	Recall:77.78%</span><br><span class="line">839    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">840    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">841    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">842    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">843    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">844    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">845    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">846    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">847    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">848    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">849    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">850    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br><span class="line">851    35    45	RPs/Img: 1.82	IOU: 57.69%	Recall:77.78%</span><br></pre></td></tr></table></figure>
<p>数据格式为<code>Number Correct Total Rps/Img IOU Recall</code></p>
<ul>
<li>Number表示处理到第几张图片。</li>
<li>Correct 表示正确的识别除了多少bbox。这个值算出来的步骤是这样的，丢进网络一张图片，网络会预测出很多 bbox，每个bbox都有其置信概率，概率大于threshold的bbox与实际的bbox，也就是labels中txt的内容计算IOU，找出IOU最大的bbox，如果这个最大值大于预设的IOU的threshold，那么correct加一。</li>
<li>Total表示实际有多少个bbox。</li>
<li>Rps/img表示平均每个图片会预测出来多少个bbox。</li>
<li>IOU： 这个是预测出的bbox和实际标注的bbox的交集 除以 他们的并集。显然，这个数值越大，说明预测的结果越好。</li>
<li>Recall召回率， 意思是检测出物体的个数 除以 标注的所有物体个数。通过代码我们也能看出来就是Correct除以Total的值。</li>
</ul>
<p>计算的是全部图片的 recall 和 IOU,而不是单类的,不是很方便.</p>
<h2 id="计算-mAP"><a href="#计算-mAP" class="headerlink" title="计算 mAP"></a>计算 mAP</h2><h3 id="reval-voc-py"><a href="#reval-voc-py" class="headerlink" title="reval_voc.py"></a>reval_voc.py</h3><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Adapt from -&gt;</span></span><br><span class="line"><span class="hljs-comment"># --------------------------------------------------------</span></span><br><span class="line"><span class="hljs-comment"># Fast R-CNN</span></span><br><span class="line"><span class="hljs-comment"># Copyright (c) 2015 Microsoft</span></span><br><span class="line"><span class="hljs-comment"># Licensed under The MIT License [see LICENSE for details]</span></span><br><span class="line"><span class="hljs-comment"># Written by Ross Girshick</span></span><br><span class="line"><span class="hljs-comment"># --------------------------------------------------------</span></span><br><span class="line"><span class="hljs-comment"># &lt;- Written by Yaping Sun</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-string">"""Reval = re-eval. Re-evaluate saved detections."""</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> os, sys, argparse</span><br><span class="line"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np</span><br><span class="line"><span class="hljs-keyword">import</span> cPickle</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">from</span> voc_eval <span class="hljs-keyword">import</span> voc_eval</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_args</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    <span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-string">    Parse input arguments</span></span><br><span class="line"><span class="hljs-string">    """</span></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="hljs-string">'Re-evaluate results'</span>)</span><br><span class="line">    parser.add_argument(<span class="hljs-string">'output_dir'</span>, nargs=<span class="hljs-number">1</span>, help=<span class="hljs-string">'results directory'</span>,</span><br><span class="line">                        type=str)</span><br><span class="line">    parser.add_argument(<span class="hljs-string">'--voc_dir'</span>, dest=<span class="hljs-string">'voc_dir'</span>, default=<span class="hljs-string">'data/VOCdevkit'</span>, type=str)</span><br><span class="line">    parser.add_argument(<span class="hljs-string">'--year'</span>, dest=<span class="hljs-string">'year'</span>, default=<span class="hljs-string">'2017'</span>, type=str)</span><br><span class="line">    parser.add_argument(<span class="hljs-string">'--image_set'</span>, dest=<span class="hljs-string">'image_set'</span>, default=<span class="hljs-string">'test'</span>, type=str)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="hljs-string">'--classes'</span>, dest=<span class="hljs-string">'class_file'</span>, default=<span class="hljs-string">'data/voc.names'</span>, type=str)</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> len(sys.argv) == <span class="hljs-number">1</span>:</span><br><span class="line">        parser.print_help()</span><br><span class="line">        sys.exit(<span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="hljs-keyword">return</span> args</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_voc_results_file_template</span><span class="hljs-params">(image_set, out_dir = <span class="hljs-string">'results'</span>)</span>:</span></span><br><span class="line">    filename = <span class="hljs-string">'comp4_det_'</span> + image_set + <span class="hljs-string">'_&#123;:s&#125;.txt'</span></span><br><span class="line">    path = os.path.join(out_dir, filename)</span><br><span class="line">    <span class="hljs-keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">do_python_eval</span><span class="hljs-params">(devkit_path, year, image_set, classes, output_dir = <span class="hljs-string">'results'</span>)</span>:</span></span><br><span class="line">    annopath = os.path.join(</span><br><span class="line">        devkit_path,</span><br><span class="line">        <span class="hljs-string">'VOC'</span> + year,</span><br><span class="line">        <span class="hljs-string">'Annotations'</span>,</span><br><span class="line">        <span class="hljs-string">'&#123;:s&#125;.xml'</span>)</span><br><span class="line">    imagesetfile = os.path.join(</span><br><span class="line">        devkit_path,</span><br><span class="line">        <span class="hljs-string">'VOC'</span> + year,</span><br><span class="line">        <span class="hljs-string">'ImageSets'</span>,</span><br><span class="line">        <span class="hljs-string">'Main'</span>,</span><br><span class="line">        image_set + <span class="hljs-string">'.txt'</span>)</span><br><span class="line">    cachedir = os.path.join(devkit_path, <span class="hljs-string">'annotations_cache'</span>)</span><br><span class="line">    aps = []</span><br><span class="line">    <span class="hljs-comment"># The PASCAL VOC metric changed in 2010</span></span><br><span class="line">    use_07_metric = <span class="hljs-keyword">True</span> <span class="hljs-keyword">if</span> int(year) &lt; <span class="hljs-number">2010</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">False</span></span><br><span class="line">    print(<span class="hljs-string">'VOC07 metric? '</span> + (<span class="hljs-string">'Yes'</span> <span class="hljs-keyword">if</span> use_07_metric <span class="hljs-keyword">else</span> <span class="hljs-string">'No'</span>))</span><br><span class="line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isdir(output_dir):</span><br><span class="line">        os.mkdir(output_dir)</span><br><span class="line">    <span class="hljs-keyword">for</span> i, cls <span class="hljs-keyword">in</span> enumerate(classes):</span><br><span class="line">        <span class="hljs-keyword">if</span> cls == <span class="hljs-string">'__background__'</span>:</span><br><span class="line">            <span class="hljs-keyword">continue</span></span><br><span class="line">        filename = get_voc_results_file_template(image_set).format(cls)</span><br><span class="line">        rec, prec, ap = voc_eval(</span><br><span class="line">            filename, annopath, imagesetfile, cls, cachedir, ovthresh=<span class="hljs-number">0.5</span>,</span><br><span class="line">            use_07_metric=use_07_metric)</span><br><span class="line">        aps += [ap]</span><br><span class="line">        print(<span class="hljs-string">'AP for &#123;&#125; = &#123;:.4f&#125;'</span>.format(cls, ap))</span><br><span class="line">        <span class="hljs-keyword">with</span> open(os.path.join(output_dir, cls + <span class="hljs-string">'_pr.pkl'</span>), <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">            cPickle.dump(&#123;<span class="hljs-string">'rec'</span>: rec, <span class="hljs-string">'prec'</span>: prec, <span class="hljs-string">'ap'</span>: ap&#125;, f)</span><br><span class="line">    print(<span class="hljs-string">'Mean AP = &#123;:.4f&#125;'</span>.format(np.mean(aps)))</span><br><span class="line">    print(<span class="hljs-string">'~~~~~~~~'</span>)</span><br><span class="line">    print(<span class="hljs-string">'Results:'</span>)</span><br><span class="line">    <span class="hljs-keyword">for</span> ap <span class="hljs-keyword">in</span> aps:</span><br><span class="line">        print(<span class="hljs-string">'&#123;:.3f&#125;'</span>.format(ap))</span><br><span class="line">    print(<span class="hljs-string">'&#123;:.3f&#125;'</span>.format(np.mean(aps)))</span><br><span class="line">    print(<span class="hljs-string">'~~~~~~~~'</span>)</span><br><span class="line">    print(<span class="hljs-string">''</span>)</span><br><span class="line">    print(<span class="hljs-string">'--------------------------------------------------------------'</span>)</span><br><span class="line">    print(<span class="hljs-string">'Results computed with the **unofficial** Python eval code.'</span>)</span><br><span class="line">    print(<span class="hljs-string">'Results should be very close to the official MATLAB eval code.'</span>)</span><br><span class="line">    print(<span class="hljs-string">'-- Thanks, The Management'</span>)</span><br><span class="line">    print(<span class="hljs-string">'--------------------------------------------------------------'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:</span><br><span class="line">    args = parse_args()</span><br><span class="line"></span><br><span class="line">    output_dir = os.path.abspath(args.output_dir[<span class="hljs-number">0</span>])</span><br><span class="line">    <span class="hljs-keyword">with</span> open(args.class_file, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line"></span><br><span class="line">    classes = [t.strip(<span class="hljs-string">'\n'</span>) <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> lines]</span><br><span class="line"></span><br><span class="line">    print(<span class="hljs-string">'Evaluating detections'</span>)</span><br><span class="line">    do_python_eval(args.voc_dir, args.year, args.image_set, classes, output_dir)</span><br></pre></td></tr></table></figure>
<h3 id="voc-eval-py"><a href="#voc-eval-py" class="headerlink" title="voc_eval.py"></a>voc_eval.py</h3><figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># --------------------------------------------------------</span></span><br><span class="line"><span class="hljs-comment"># Fast/er R-CNN</span></span><br><span class="line"><span class="hljs-comment"># Licensed under The MIT License [see LICENSE for details]</span></span><br><span class="line"><span class="hljs-comment"># Written by Bharath Hariharan</span></span><br><span class="line"><span class="hljs-comment"># --------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> xml.etree.ElementTree <span class="hljs-keyword">as</span> ET</span><br><span class="line"><span class="hljs-keyword">import</span> os</span><br><span class="line"><span class="hljs-keyword">import</span> pickle</span><br><span class="line"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_rec</span><span class="hljs-params">(filename)</span>:</span></span><br><span class="line">    <span class="hljs-string">""" Parse a PASCAL VOC xml file """</span></span><br><span class="line">    tree = ET.parse(filename)</span><br><span class="line">    objects = []</span><br><span class="line">    <span class="hljs-keyword">for</span> obj <span class="hljs-keyword">in</span> tree.findall(<span class="hljs-string">'object'</span>):</span><br><span class="line">        obj_struct = &#123;&#125;</span><br><span class="line">        obj_struct[<span class="hljs-string">'name'</span>] = obj.find(<span class="hljs-string">'name'</span>).text</span><br><span class="line">        obj_struct[<span class="hljs-string">'pose'</span>] = obj.find(<span class="hljs-string">'pose'</span>).text</span><br><span class="line">        obj_struct[<span class="hljs-string">'truncated'</span>] = int(obj.find(<span class="hljs-string">'truncated'</span>).text)</span><br><span class="line">        obj_struct[<span class="hljs-string">'difficult'</span>] = int(obj.find(<span class="hljs-string">'difficult'</span>).text)</span><br><span class="line">        bbox = obj.find(<span class="hljs-string">'bndbox'</span>)</span><br><span class="line">        obj_struct[<span class="hljs-string">'bbox'</span>] = [int(bbox.find(<span class="hljs-string">'xmin'</span>).text),</span><br><span class="line">                              int(bbox.find(<span class="hljs-string">'ymin'</span>).text),</span><br><span class="line">                              int(bbox.find(<span class="hljs-string">'xmax'</span>).text),</span><br><span class="line">                              int(bbox.find(<span class="hljs-string">'ymax'</span>).text)]</span><br><span class="line">        objects.append(obj_struct)</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> objects</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">voc_ap</span><span class="hljs-params">(rec, prec, use_07_metric=False)</span>:</span></span><br><span class="line">    <span class="hljs-string">""" ap = voc_ap(rec, prec, [use_07_metric])</span></span><br><span class="line"><span class="hljs-string">    Compute VOC AP given precision and recall.</span></span><br><span class="line"><span class="hljs-string">    If use_07_metric is true, uses the</span></span><br><span class="line"><span class="hljs-string">    VOC 07 11 point method (default:False).</span></span><br><span class="line"><span class="hljs-string">    """</span></span><br><span class="line">    <span class="hljs-keyword">if</span> use_07_metric:</span><br><span class="line">        <span class="hljs-comment"># 11 point metric</span></span><br><span class="line">        ap = <span class="hljs-number">0.</span></span><br><span class="line">        <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> np.arange(<span class="hljs-number">0.</span>, <span class="hljs-number">1.1</span>, <span class="hljs-number">0.1</span>):</span><br><span class="line">            <span class="hljs-keyword">if</span> np.sum(rec &gt;= t) == <span class="hljs-number">0</span>:</span><br><span class="line">                p = <span class="hljs-number">0</span></span><br><span class="line">            <span class="hljs-keyword">else</span>:</span><br><span class="line">                p = np.max(prec[rec &gt;= t])</span><br><span class="line">            ap = ap + p / <span class="hljs-number">11.</span></span><br><span class="line">    <span class="hljs-keyword">else</span>:</span><br><span class="line">        <span class="hljs-comment"># correct AP calculation</span></span><br><span class="line">        <span class="hljs-comment"># first append sentinel values at the end</span></span><br><span class="line">        mrec = np.concatenate(([<span class="hljs-number">0.</span>], rec, [<span class="hljs-number">1.</span>]))</span><br><span class="line">        mpre = np.concatenate(([<span class="hljs-number">0.</span>], prec, [<span class="hljs-number">0.</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment"># compute the precision envelope</span></span><br><span class="line">        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(mpre.size - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>):</span><br><span class="line">            mpre[i - <span class="hljs-number">1</span>] = np.maximum(mpre[i - <span class="hljs-number">1</span>], mpre[i])</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment"># to calculate area under PR curve, look for points</span></span><br><span class="line">        <span class="hljs-comment"># where X axis (recall) changes value</span></span><br><span class="line">        i = np.where(mrec[<span class="hljs-number">1</span>:] != mrec[:<span class="hljs-number">-1</span>])[<span class="hljs-number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment"># and sum (\Delta recall) * prec</span></span><br><span class="line">        ap = np.sum((mrec[i + <span class="hljs-number">1</span>] - mrec[i]) * mpre[i + <span class="hljs-number">1</span>])</span><br><span class="line">    <span class="hljs-keyword">return</span> ap</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">voc_eval</span><span class="hljs-params">(detpath,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">             annopath,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">             imagesetfile,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">             classname,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">             cachedir,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">             ovthresh=<span class="hljs-number">0.5</span>,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">             use_07_metric=False)</span>:</span></span><br><span class="line">    <span class="hljs-string">"""rec, prec, ap = voc_eval(detpath,</span></span><br><span class="line"><span class="hljs-string">                                annopath,</span></span><br><span class="line"><span class="hljs-string">                                imagesetfile,</span></span><br><span class="line"><span class="hljs-string">                                classname,</span></span><br><span class="line"><span class="hljs-string">                                [ovthresh],</span></span><br><span class="line"><span class="hljs-string">                                [use_07_metric])</span></span><br><span class="line"><span class="hljs-string">    Top level function that does the PASCAL VOC evaluation.</span></span><br><span class="line"><span class="hljs-string">    detpath: Path to detections</span></span><br><span class="line"><span class="hljs-string">        detpath.format(classname) should produce the detection results file.</span></span><br><span class="line"><span class="hljs-string">    annopath: Path to annotations</span></span><br><span class="line"><span class="hljs-string">        annopath.format(imagename) should be the xml annotations file.</span></span><br><span class="line"><span class="hljs-string">    imagesetfile: Text file containing the list of images, one image per line.</span></span><br><span class="line"><span class="hljs-string">    classname: Category name (duh)</span></span><br><span class="line"><span class="hljs-string">    cachedir: Directory for caching the annotations</span></span><br><span class="line"><span class="hljs-string">    [ovthresh]: Overlap threshold (default = 0.5)</span></span><br><span class="line"><span class="hljs-string">    [use_07_metric]: Whether to use VOC07's 11 point AP computation</span></span><br><span class="line"><span class="hljs-string">        (default False)</span></span><br><span class="line"><span class="hljs-string">    """</span></span><br><span class="line">    <span class="hljs-comment"># assumes detections are in detpath.format(classname)</span></span><br><span class="line">    <span class="hljs-comment"># assumes annotations are in annopath.format(imagename)</span></span><br><span class="line">    <span class="hljs-comment"># assumes imagesetfile is a text file with each line an image name</span></span><br><span class="line">    <span class="hljs-comment"># cachedir caches the annotations in a pickle file</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># first load gt</span></span><br><span class="line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isdir(cachedir):</span><br><span class="line">        os.mkdir(cachedir)</span><br><span class="line">    cachefile = os.path.join(cachedir, <span class="hljs-string">'annots.pkl'</span>)</span><br><span class="line">    <span class="hljs-comment"># read list of images</span></span><br><span class="line">    <span class="hljs-keyword">with</span> open(imagesetfile, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line">    imagenames = [x.strip() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> lines]</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isfile(cachefile):</span><br><span class="line">        <span class="hljs-comment"># load annots</span></span><br><span class="line">        recs = &#123;&#125;</span><br><span class="line">        <span class="hljs-keyword">for</span> i, imagename <span class="hljs-keyword">in</span> enumerate(imagenames):</span><br><span class="line">            recs[imagename] = parse_rec(annopath.format(imagename))</span><br><span class="line">            <span class="hljs-keyword">if</span> i % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:</span><br><span class="line">                <span class="hljs-keyword">print</span> (<span class="hljs-string">'Reading annotation for &#123;:d&#125;/&#123;:d&#125;'</span>.format(</span><br><span class="line">                    i + <span class="hljs-number">1</span>, len(imagenames)))</span><br><span class="line">        <span class="hljs-comment"># save</span></span><br><span class="line">        <span class="hljs-keyword">print</span> (<span class="hljs-string">'Saving cached annotations to &#123;:s&#125;'</span>.format(cachefile))</span><br><span class="line">        <span class="hljs-keyword">with</span> open(cachefile, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">            pickle.dump(recs, f)</span><br><span class="line">    <span class="hljs-keyword">else</span>:</span><br><span class="line">        <span class="hljs-comment"># load</span></span><br><span class="line">        <span class="hljs-keyword">with</span> open(cachefile, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">            recs = pickle.load(f)</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># extract gt objects for this class</span></span><br><span class="line">    class_recs = &#123;&#125;</span><br><span class="line">    npos = <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-keyword">for</span> imagename <span class="hljs-keyword">in</span> imagenames:</span><br><span class="line">        R = [obj <span class="hljs-keyword">for</span> obj <span class="hljs-keyword">in</span> recs[imagename] <span class="hljs-keyword">if</span> obj[<span class="hljs-string">'name'</span>] == classname]</span><br><span class="line">        difficult = np.array([x[<span class="hljs-string">'difficult'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> R]).astype(np.bool)</span><br><span class="line">        bbox = np.array([x[<span class="hljs-string">'bbox'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> R])</span><br><span class="line">        <span class="hljs-comment">#difficult = np.array([x['difficult'] for x in R]).astype(np.bool)</span></span><br><span class="line">        det = [<span class="hljs-keyword">False</span>] * len(R)</span><br><span class="line">        npos = npos + sum(~difficult)</span><br><span class="line">        class_recs[imagename] = &#123;<span class="hljs-string">'bbox'</span>: bbox,</span><br><span class="line">                                 <span class="hljs-comment">#'difficult': difficult,</span></span><br><span class="line">                                 <span class="hljs-string">'det'</span>: det&#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># read dets</span></span><br><span class="line">    detfile = detpath.format(classname)</span><br><span class="line">    <span class="hljs-keyword">with</span> open(detfile, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line"></span><br><span class="line">    splitlines = [x.strip().split(<span class="hljs-string">' '</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> lines]</span><br><span class="line">    image_ids = [x[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> splitlines]</span><br><span class="line">    confidence = np.array([float(x[<span class="hljs-number">1</span>]) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> splitlines])</span><br><span class="line">    BB = np.array([[float(z) <span class="hljs-keyword">for</span> z <span class="hljs-keyword">in</span> x[<span class="hljs-number">2</span>:]] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> splitlines])</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># sort by confidence</span></span><br><span class="line">    sorted_ind = np.argsort(-confidence)</span><br><span class="line">    sorted_scores = np.sort(-confidence)</span><br><span class="line">    BB = BB[sorted_ind, :]</span><br><span class="line">    image_ids = [image_ids[x] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> sorted_ind]</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># go down dets and mark TPs and FPs</span></span><br><span class="line">    nd = len(image_ids)</span><br><span class="line">    tp = np.zeros(nd)</span><br><span class="line">    fp = np.zeros(nd)</span><br><span class="line">    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> range(nd):</span><br><span class="line">        R = class_recs[image_ids[d]]</span><br><span class="line">        bb = BB[d, :].astype(float)</span><br><span class="line">        ovmax = -np.inf</span><br><span class="line">        BBGT = R[<span class="hljs-string">'bbox'</span>].astype(float)</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> BBGT.size &gt; <span class="hljs-number">0</span>:</span><br><span class="line">            <span class="hljs-comment"># compute overlaps</span></span><br><span class="line">            <span class="hljs-comment"># intersection</span></span><br><span class="line">            ixmin = np.maximum(BBGT[:, <span class="hljs-number">0</span>], bb[<span class="hljs-number">0</span>])</span><br><span class="line">            iymin = np.maximum(BBGT[:, <span class="hljs-number">1</span>], bb[<span class="hljs-number">1</span>])</span><br><span class="line">            ixmax = np.minimum(BBGT[:, <span class="hljs-number">2</span>], bb[<span class="hljs-number">2</span>])</span><br><span class="line">            iymax = np.minimum(BBGT[:, <span class="hljs-number">3</span>], bb[<span class="hljs-number">3</span>])</span><br><span class="line">            iw = np.maximum(ixmax - ixmin + <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>)</span><br><span class="line">            ih = np.maximum(iymax - iymin + <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>)</span><br><span class="line">            inters = iw * ih</span><br><span class="line"></span><br><span class="line">            <span class="hljs-comment"># union</span></span><br><span class="line">            uni = ((bb[<span class="hljs-number">2</span>] - bb[<span class="hljs-number">0</span>] + <span class="hljs-number">1.</span>) * (bb[<span class="hljs-number">3</span>] - bb[<span class="hljs-number">1</span>] + <span class="hljs-number">1.</span>) +</span><br><span class="line">                   (BBGT[:, <span class="hljs-number">2</span>] - BBGT[:, <span class="hljs-number">0</span>] + <span class="hljs-number">1.</span>) *</span><br><span class="line">                   (BBGT[:, <span class="hljs-number">3</span>] - BBGT[:, <span class="hljs-number">1</span>] + <span class="hljs-number">1.</span>) - inters)</span><br><span class="line"></span><br><span class="line">            overlaps = inters / uni</span><br><span class="line">            ovmax = np.max(overlaps)</span><br><span class="line">            jmax = np.argmax(overlaps)</span><br><span class="line">        <span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-string">        if ovmax &gt; ovthresh:</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">            if not False:</span></span><br><span class="line"><span class="hljs-string">                if not R['det'][jmax]:</span></span><br><span class="line"><span class="hljs-string">                    tp[d] = 1.</span></span><br><span class="line"><span class="hljs-string">                    R['det'][jmax] = 1</span></span><br><span class="line"><span class="hljs-string">                else:</span></span><br><span class="line"><span class="hljs-string">                    fp[d] = 1.</span></span><br><span class="line"><span class="hljs-string">        else:</span></span><br><span class="line"><span class="hljs-string">            fp[d] = 1.</span></span><br><span class="line"><span class="hljs-string">        """</span></span><br><span class="line">        <span class="hljs-keyword">if</span> ovmax &gt; ovthresh:</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">False</span>:</span><br><span class="line">                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> R[<span class="hljs-string">'det'</span>][jmax]:</span><br><span class="line">                    tp[d] = <span class="hljs-number">1.</span></span><br><span class="line">                    R[<span class="hljs-string">'det'</span>][jmax] = <span class="hljs-number">1</span></span><br><span class="line">                <span class="hljs-keyword">else</span>:</span><br><span class="line">                    fp[d] = <span class="hljs-number">1.</span></span><br><span class="line">        <span class="hljs-keyword">else</span>:</span><br><span class="line">            fp[d] = <span class="hljs-number">1.</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># compute precision recall</span></span><br><span class="line">    fp = np.cumsum(fp)</span><br><span class="line">    tp = np.cumsum(tp)</span><br><span class="line">    rec = tp / float(npos)</span><br><span class="line">    <span class="hljs-comment"># avoid divide by zero in case the first detection matches a difficult</span></span><br><span class="line">    <span class="hljs-comment"># ground truth</span></span><br><span class="line">    prec = tp / np.maximum(tp + fp, np.finfo(np.float64).eps)</span><br><span class="line">    ap = voc_ap(rec, prec, use_07_metric)</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> rec, prec, ap</span><br></pre></td></tr></table></figure>
<h3 id="computer-Single-ALL-mAP-py"><a href="#computer-Single-ALL-mAP-py" class="headerlink" title="computer_Single_ALL_mAP.py"></a>computer_Single_ALL_mAP.py</h3><ul>
<li>results_path = “填写前面生成的 results 文件的路径”</li>
<li>/xxx/results/{}.txt - results_path 的路径</li>
<li>/xxx/{}.xml - xml 格式的标注文件</li>
<li>/xxx/list.txt - 只包含图片名字的列表文件</li>
</ul>
<p>执行 computer_Single_ALL_mAP.py 将会生成各个分类的 mAP.</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> voc_eval <span class="hljs-keyword">import</span> voc_eval </span><br><span class="line"><span class="hljs-keyword">import</span> os </span><br><span class="line"></span><br><span class="line">current_path = os.getcwd()</span><br><span class="line"></span><br><span class="line">results_path = <span class="hljs-string">"填写前面生成的 results 文件的路径"</span></span><br><span class="line">sub_files = os.listdir(results_path) </span><br><span class="line"></span><br><span class="line">mAP = [] </span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(sub_files)): </span><br><span class="line">    class_name = sub_files[i].split(<span class="hljs-string">".txt"</span>)[<span class="hljs-number">0</span>]</span><br><span class="line">    rec, prec, ap = voc_eval(<span class="hljs-string">'/xxx/results/&#123;&#125;.txt'</span>, <span class="hljs-string">'/xxx/&#123;&#125;.xml'</span>, <span class="hljs-string">'/xxx/list.txt'</span>, class_name, <span class="hljs-string">'.'</span>)</span><br><span class="line">    <span class="hljs-comment"># print("&#123;&#125; :\t &#123;&#125; ".format(class_name, ap)) </span></span><br><span class="line">    print(<span class="hljs-string">"&#123;&#125; :\t &#123;&#125; "</span>.format(class_name, ap)) </span><br><span class="line">    mAP.append(ap) </span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># class_name = 'switch_open'</span></span><br><span class="line"><span class="hljs-comment"># rec, prec, ap = voc_eval('/aseit-data/program/darknet/results/&#123;&#125;.txt', '/aseit-data/data_set/swich/dataset_test/switch_mAP/&#123;&#125;.xml', '/aseit-data/data_set/swich/dataset_test/list.txt', class_name, '.')</span></span><br><span class="line"><span class="hljs-comment"># print("&#123;&#125; :\t &#123;&#125; ".format(class_name, ap)) </span></span><br><span class="line"><span class="hljs-comment"># mAP.append(ap) </span></span><br><span class="line"></span><br><span class="line">mAP = tuple(mAP) </span><br><span class="line">print(<span class="hljs-string">"***************************"</span>) </span><br><span class="line">print(<span class="hljs-string">"mAP :\t &#123;&#125;"</span>.format( float( sum(mAP)/len(mAP)) ))</span><br></pre></td></tr></table></figure>
<h2 id="detector-c"><a href="#detector-c" class="headerlink" title="detector.c"></a>detector.c</h2><p>在 test 和计算 recall 的时候需要修改 examples/detector.c 如下:</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"darknet.h"</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> coco_ids[] = &#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>,<span class="hljs-number">18</span>,<span class="hljs-number">19</span>,<span class="hljs-number">20</span>,<span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">23</span>,<span class="hljs-number">24</span>,<span class="hljs-number">25</span>,<span class="hljs-number">27</span>,<span class="hljs-number">28</span>,<span class="hljs-number">31</span>,<span class="hljs-number">32</span>,<span class="hljs-number">33</span>,<span class="hljs-number">34</span>,<span class="hljs-number">35</span>,<span class="hljs-number">36</span>,<span class="hljs-number">37</span>,<span class="hljs-number">38</span>,<span class="hljs-number">39</span>,<span class="hljs-number">40</span>,</span><br><span class="line"><span class="hljs-number">41</span>,<span class="hljs-number">42</span>,<span class="hljs-number">43</span>,<span class="hljs-number">44</span>,<span class="hljs-number">46</span>,<span class="hljs-number">47</span>,<span class="hljs-number">48</span>,<span class="hljs-number">49</span>,<span class="hljs-number">50</span>,<span class="hljs-number">51</span>,<span class="hljs-number">52</span>,<span class="hljs-number">53</span>,<span class="hljs-number">54</span>,<span class="hljs-number">55</span>,<span class="hljs-number">56</span>,<span class="hljs-number">57</span>,<span class="hljs-number">58</span>,<span class="hljs-number">59</span>,<span class="hljs-number">60</span>,<span class="hljs-number">61</span>,<span class="hljs-number">62</span>,<span class="hljs-number">63</span>,<span class="hljs-number">64</span>,<span class="hljs-number">65</span>,<span class="hljs-number">67</span>,<span class="hljs-number">70</span>,<span class="hljs-number">72</span>,<span class="hljs-number">73</span>,<span class="hljs-number">74</span>,<span class="hljs-number">75</span>,<span class="hljs-number">76</span>,<span class="hljs-number">77</span>,<span class="hljs-number">78</span>,<span class="hljs-number">79</span>,<span class="hljs-number">80</span>,<span class="hljs-number">81</span>,<span class="hljs-number">82</span>,<span class="hljs-number">84</span>,<span class="hljs-number">85</span>,<span class="hljs-number">86</span>,<span class="hljs-number">87</span>,<span class="hljs-number">88</span>,<span class="hljs-number">89</span>,<span class="hljs-number">90</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">char</span> *<span class="hljs-title">GetFilename</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *fullname)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> from,to,i;</span><br><span class="line">    <span class="hljs-keyword">char</span> *newstr,*temp;</span><br><span class="line">    <span class="hljs-keyword">if</span>(fullname!=<span class="hljs-literal">NULL</span>)&#123;</span><br><span class="line">        <span class="hljs-comment">//if not find dot</span></span><br><span class="line">        <span class="hljs-keyword">if</span>((temp=<span class="hljs-built_in">strchr</span>(fullname,<span class="hljs-string">'.'</span>))==<span class="hljs-literal">NULL</span>)&#123;</span><br><span class="line">        newstr = fullname;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            from = <span class="hljs-built_in">strlen</span>(fullname) - <span class="hljs-built_in">strlen</span>(temp);</span><br><span class="line">            to = (temp-fullname);</span><br><span class="line">            <span class="hljs-comment">//the first dot's index</span></span><br><span class="line">            <span class="hljs-keyword">for</span> (i=from; i&lt;=to; i--)&#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (fullname[i]==<span class="hljs-string">'.'</span>) <span class="hljs-keyword">break</span>;<span class="hljs-comment">//find the last dot</span></span><br><span class="line">            &#125;</span><br><span class="line">            newstr = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(i+<span class="hljs-number">1</span>);</span><br><span class="line">            <span class="hljs-built_in">strncpy</span>(newstr,fullname,i);</span><br><span class="line">            *(newstr+i)=<span class="hljs-number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> name[<span class="hljs-number">50</span>] = &#123;<span class="hljs-string">""</span>&#125;;</span><br><span class="line">    <span class="hljs-keyword">char</span> *q = <span class="hljs-built_in">strrchr</span>(newstr,<span class="hljs-string">'/'</span>) + <span class="hljs-number">1</span>;</span><br><span class="line">    <span class="hljs-built_in">strncpy</span>(name,q,<span class="hljs-number">40</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">train_detector</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *datacfg, <span class="hljs-keyword">char</span> *cfgfile, <span class="hljs-keyword">char</span> *weightfile, <span class="hljs-keyword">int</span> *gpus, <span class="hljs-keyword">int</span> ngpus, <span class="hljs-keyword">int</span> clear)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-built_in">list</span> *options = read_data_cfg(datacfg); <span class="hljs-comment">//解析data文件，用自定义链表options存储训练集基本信息，函数位于option_list.c</span></span><br><span class="line">    <span class="hljs-keyword">char</span> *train_images = option_find_str(options, <span class="hljs-string">"train"</span>, <span class="hljs-string">"data/train.list"</span>);  <span class="hljs-comment">//从options中找训练集</span></span><br><span class="line">    <span class="hljs-keyword">char</span> *backup_directory = option_find_str(options, <span class="hljs-string">"backup"</span>, <span class="hljs-string">"/backup/"</span>);    <span class="hljs-comment">//从options中找backup路径</span></span><br><span class="line"></span><br><span class="line">    srand(time(<span class="hljs-number">0</span>)); <span class="hljs-comment">//初始化随机种子数</span></span><br><span class="line">    <span class="hljs-keyword">char</span> *base = basecfg(cfgfile);  <span class="hljs-comment">//此函数位于utils.c,返回cfg文件不带后缀的名字</span></span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>, base);</span><br><span class="line">    <span class="hljs-keyword">float</span> avg_loss = <span class="hljs-number">-1</span>;</span><br><span class="line">    network **nets = <span class="hljs-built_in">calloc</span>(ngpus, <span class="hljs-keyword">sizeof</span>(network));</span><br><span class="line"></span><br><span class="line">    srand(time(<span class="hljs-number">0</span>));</span><br><span class="line">    <span class="hljs-keyword">int</span> seed = rand();</span><br><span class="line">    <span class="hljs-keyword">int</span> i;</span><br><span class="line">    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; ngpus; ++i)&#123;</span><br><span class="line">        srand(seed);</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> GPU</span></span><br><span class="line">        cuda_set_device(gpus[i]);</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line">        nets[i] = load_network(cfgfile, weightfile, clear);</span><br><span class="line">        nets[i]-&gt;learning_rate *= ngpus;</span><br><span class="line">    &#125;</span><br><span class="line">    srand(time(<span class="hljs-number">0</span>));</span><br><span class="line">    network *net = nets[<span class="hljs-number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> imgs = net-&gt;batch * net-&gt;subdivisions * ngpus;</span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Learning Rate: %g, Momentum: %g, Decay: %g\n"</span>, net-&gt;learning_rate, net-&gt;momentum, net-&gt;decay);</span><br><span class="line">    data train, buffer;</span><br><span class="line"></span><br><span class="line">    layer l = net-&gt;layers[net-&gt;n - <span class="hljs-number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> classes = l.classes;</span><br><span class="line">    <span class="hljs-keyword">float</span> jitter = l.jitter;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-built_in">list</span> *plist = get_paths(train_images);</span><br><span class="line">    <span class="hljs-comment">//int N = plist-&gt;size;</span></span><br><span class="line">    <span class="hljs-keyword">char</span> **paths = (<span class="hljs-keyword">char</span> **)list_to_array(plist);</span><br><span class="line"></span><br><span class="line">    load_args args = get_base_args(net);</span><br><span class="line">    args.coords = l.coords;</span><br><span class="line">    args.paths = paths;</span><br><span class="line">    args.n = imgs;</span><br><span class="line">    args.m = plist-&gt;size;</span><br><span class="line">    args.classes = classes;</span><br><span class="line">    args.jitter = jitter;</span><br><span class="line">    args.num_boxes = l.max_boxes;</span><br><span class="line">    args.d = &amp;buffer;</span><br><span class="line">    args.type = DETECTION_DATA;</span><br><span class="line">    <span class="hljs-comment">//args.type = INSTANCE_DATA;</span></span><br><span class="line">    args.threads = <span class="hljs-number">64</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">pthread_t</span> load_thread = load_data(args);</span><br><span class="line">    <span class="hljs-keyword">double</span> time;</span><br><span class="line">    <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-comment">//while(i*imgs &lt; N*120)&#123;</span></span><br><span class="line">    <span class="hljs-keyword">while</span>(get_current_batch(net) &lt; net-&gt;max_batches)&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span>(l.random &amp;&amp; count++%<span class="hljs-number">10</span> == <span class="hljs-number">0</span>)&#123;</span><br><span class="line">            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Resizing\n"</span>);</span><br><span class="line">            <span class="hljs-keyword">int</span> dim = (rand() % <span class="hljs-number">10</span> + <span class="hljs-number">10</span>) * <span class="hljs-number">32</span>;</span><br><span class="line">            <span class="hljs-keyword">if</span> (get_current_batch(net)+<span class="hljs-number">200</span> &gt; net-&gt;max_batches) dim = <span class="hljs-number">608</span>;</span><br><span class="line">            <span class="hljs-comment">//int dim = (rand() % 4 + 16) * 32;</span></span><br><span class="line">            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, dim);</span><br><span class="line">            args.w = dim;</span><br><span class="line">            args.h = dim;</span><br><span class="line"></span><br><span class="line">            pthread_join(load_thread, <span class="hljs-number">0</span>);</span><br><span class="line">            train = buffer;</span><br><span class="line">            free_data(train);</span><br><span class="line">            load_thread = load_data(args);</span><br><span class="line"></span><br><span class="line">            <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line">            <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; ngpus; ++i)&#123;</span><br><span class="line">                resize_network(nets[i], dim, dim);</span><br><span class="line">            &#125;</span><br><span class="line">            net = nets[<span class="hljs-number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        time=what_time_is_it_now();</span><br><span class="line">        pthread_join(load_thread, <span class="hljs-number">0</span>);</span><br><span class="line">        train = buffer;</span><br><span class="line">        load_thread = load_data(args);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">           int k;</span></span><br><span class="line"><span class="hljs-comment">           for(k = 0; k &lt; l.max_boxes; ++k)&#123;</span></span><br><span class="line"><span class="hljs-comment">           box b = float_to_box(train.y.vals[10] + 1 + k*5);</span></span><br><span class="line"><span class="hljs-comment">           if(!b.x) break;</span></span><br><span class="line"><span class="hljs-comment">           printf("loaded: %f %f %f %f\n", b.x, b.y, b.w, b.h);</span></span><br><span class="line"><span class="hljs-comment">           &#125;</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">           int zz;</span></span><br><span class="line"><span class="hljs-comment">           for(zz = 0; zz &lt; train.X.cols; ++zz)&#123;</span></span><br><span class="line"><span class="hljs-comment">           image im = float_to_image(net-&gt;w, net-&gt;h, 3, train.X.vals[zz]);</span></span><br><span class="line"><span class="hljs-comment">           int k;</span></span><br><span class="line"><span class="hljs-comment">           for(k = 0; k &lt; l.max_boxes; ++k)&#123;</span></span><br><span class="line"><span class="hljs-comment">           box b = float_to_box(train.y.vals[zz] + k*5, 1);</span></span><br><span class="line"><span class="hljs-comment">           printf("%f %f %f %f\n", b.x, b.y, b.w, b.h);</span></span><br><span class="line"><span class="hljs-comment">           draw_bbox(im, b, 1, 1,0,0);</span></span><br><span class="line"><span class="hljs-comment">           &#125;</span></span><br><span class="line"><span class="hljs-comment">           show_image(im, "truth11");</span></span><br><span class="line"><span class="hljs-comment">           cvWaitKey(0);</span></span><br><span class="line"><span class="hljs-comment">           save_image(im, "truth11");</span></span><br><span class="line"><span class="hljs-comment">           &#125;</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Loaded: %lf seconds\n"</span>, what_time_is_it_now()-time);</span><br><span class="line"></span><br><span class="line">        time=what_time_is_it_now();</span><br><span class="line">        <span class="hljs-keyword">float</span> loss = <span class="hljs-number">0</span>;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> GPU</span></span><br><span class="line">        <span class="hljs-keyword">if</span>(ngpus == <span class="hljs-number">1</span>)&#123;</span><br><span class="line">            loss = train_network(net, train);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            loss = train_networks(nets, ngpus, train, <span class="hljs-number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span></span><br><span class="line">        loss = train_network(net, train);</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line">        <span class="hljs-keyword">if</span> (avg_loss &lt; <span class="hljs-number">0</span>) avg_loss = loss;</span><br><span class="line">        avg_loss = avg_loss*<span class="hljs-number">.9</span> + loss*<span class="hljs-number">.1</span>;</span><br><span class="line"></span><br><span class="line">        i = get_current_batch(net);</span><br><span class="line">        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%ld: %f, %f avg, %f rate, %lf seconds, %d images\n"</span>, get_current_batch(net), loss, avg_loss, get_current_rate(net), what_time_is_it_now()-time, i*imgs);</span><br><span class="line">        <span class="hljs-keyword">if</span>(i%<span class="hljs-number">100</span>==<span class="hljs-number">0</span>)&#123;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> GPU</span></span><br><span class="line">            <span class="hljs-keyword">if</span>(ngpus != <span class="hljs-number">1</span>) sync_nets(nets, ngpus, <span class="hljs-number">0</span>);</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line">            <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];</span><br><span class="line">            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">"%s/%s.backup"</span>, backup_directory, base);</span><br><span class="line">            save_weights(net, buff);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span>(i%<span class="hljs-number">10000</span>==<span class="hljs-number">0</span> || (i &lt; <span class="hljs-number">1000</span> &amp;&amp; i%<span class="hljs-number">100</span> == <span class="hljs-number">0</span>))&#123;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> GPU</span></span><br><span class="line">            <span class="hljs-keyword">if</span>(ngpus != <span class="hljs-number">1</span>) sync_nets(nets, ngpus, <span class="hljs-number">0</span>);</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line">            <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];</span><br><span class="line">            <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">"%s/%s_%d.weights"</span>, backup_directory, base, i);</span><br><span class="line">            save_weights(net, buff);</span><br><span class="line">        &#125;</span><br><span class="line">        free_data(train);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> GPU</span></span><br><span class="line">    <span class="hljs-keyword">if</span>(ngpus != <span class="hljs-number">1</span>) sync_nets(nets, ngpus, <span class="hljs-number">0</span>);</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line">    <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];</span><br><span class="line">    <span class="hljs-built_in">sprintf</span>(buff, <span class="hljs-string">"%s/%s_final.weights"</span>, backup_directory, base);</span><br><span class="line">    save_weights(net, buff);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get_coco_image_id</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *filename)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">char</span> *p = <span class="hljs-built_in">strrchr</span>(filename, <span class="hljs-string">'/'</span>);</span><br><span class="line">    <span class="hljs-keyword">char</span> *c = <span class="hljs-built_in">strrchr</span>(filename, <span class="hljs-string">'_'</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span>(c) p = c;</span><br><span class="line">    <span class="hljs-keyword">return</span> atoi(p+<span class="hljs-number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print_cocos</span><span class="hljs-params">(FILE *fp, <span class="hljs-keyword">char</span> *image_path, detection *dets, <span class="hljs-keyword">int</span> num_boxes, <span class="hljs-keyword">int</span> classes, <span class="hljs-keyword">int</span> w, <span class="hljs-keyword">int</span> h)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> i, j;</span><br><span class="line">    <span class="hljs-keyword">int</span> image_id = get_coco_image_id(image_path);</span><br><span class="line">    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; num_boxes; ++i)&#123;</span><br><span class="line">        <span class="hljs-keyword">float</span> xmin = dets[i].bbox.x - dets[i].bbox.w/<span class="hljs-number">2.</span>;</span><br><span class="line">        <span class="hljs-keyword">float</span> xmax = dets[i].bbox.x + dets[i].bbox.w/<span class="hljs-number">2.</span>;</span><br><span class="line">        <span class="hljs-keyword">float</span> ymin = dets[i].bbox.y - dets[i].bbox.h/<span class="hljs-number">2.</span>;</span><br><span class="line">        <span class="hljs-keyword">float</span> ymax = dets[i].bbox.y + dets[i].bbox.h/<span class="hljs-number">2.</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (xmin &lt; <span class="hljs-number">0</span>) xmin = <span class="hljs-number">0</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (ymin &lt; <span class="hljs-number">0</span>) ymin = <span class="hljs-number">0</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (xmax &gt; w) xmax = w;</span><br><span class="line">        <span class="hljs-keyword">if</span> (ymax &gt; h) ymax = h;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">float</span> bx = xmin;</span><br><span class="line">        <span class="hljs-keyword">float</span> by = ymin;</span><br><span class="line">        <span class="hljs-keyword">float</span> bw = xmax - xmin;</span><br><span class="line">        <span class="hljs-keyword">float</span> bh = ymax - ymin;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; classes; ++j)&#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (dets[i].prob[j]) <span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"&#123;\"image_id\":%d, \"category_id\":%d, \"bbox\":[%f, %f, %f, %f], \"score\":%f&#125;,\n"</span>, image_id, coco_ids[j], bx, by, bw, bh, dets[i].prob[j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">print_detector_detections</span><span class="hljs-params">(FILE **fps, <span class="hljs-keyword">char</span> *id, detection *dets, <span class="hljs-keyword">int</span> total, <span class="hljs-keyword">int</span> classes, <span class="hljs-keyword">int</span> w, <span class="hljs-keyword">int</span> h)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> i, j;</span><br><span class="line">    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; total; ++i)&#123;</span><br><span class="line">        <span class="hljs-keyword">float</span> xmin = dets[i].bbox.x - dets[i].bbox.w/<span class="hljs-number">2.</span> + <span class="hljs-number">1</span>;</span><br><span class="line">        <span class="hljs-keyword">float</span> xmax = dets[i].bbox.x + dets[i].bbox.w/<span class="hljs-number">2.</span> + <span class="hljs-number">1</span>;</span><br><span class="line">        <span class="hljs-keyword">float</span> ymin = dets[i].bbox.y - dets[i].bbox.h/<span class="hljs-number">2.</span> + <span class="hljs-number">1</span>;</span><br><span class="line">        <span class="hljs-keyword">float</span> ymax = dets[i].bbox.y + dets[i].bbox.h/<span class="hljs-number">2.</span> + <span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (xmin &lt; <span class="hljs-number">1</span>) xmin = <span class="hljs-number">1</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (ymin &lt; <span class="hljs-number">1</span>) ymin = <span class="hljs-number">1</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (xmax &gt; w) xmax = w;</span><br><span class="line">        <span class="hljs-keyword">if</span> (ymax &gt; h) ymax = h;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; classes; ++j)&#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (dets[i].prob[j]) <span class="hljs-built_in">fprintf</span>(fps[j], <span class="hljs-string">"%s %f %f %f %f %f\n"</span>, id, dets[i].prob[j],</span><br><span class="line">                    xmin, ymin, xmax, ymax);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">print_imagenet_detections</span><span class="hljs-params">(FILE *fp, <span class="hljs-keyword">int</span> id, detection *dets, <span class="hljs-keyword">int</span> total, <span class="hljs-keyword">int</span> classes, <span class="hljs-keyword">int</span> w, <span class="hljs-keyword">int</span> h)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> i, j;</span><br><span class="line">    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; total; ++i)&#123;</span><br><span class="line">        <span class="hljs-keyword">float</span> xmin = dets[i].bbox.x - dets[i].bbox.w/<span class="hljs-number">2.</span>;</span><br><span class="line">        <span class="hljs-keyword">float</span> xmax = dets[i].bbox.x + dets[i].bbox.w/<span class="hljs-number">2.</span>;</span><br><span class="line">        <span class="hljs-keyword">float</span> ymin = dets[i].bbox.y - dets[i].bbox.h/<span class="hljs-number">2.</span>;</span><br><span class="line">        <span class="hljs-keyword">float</span> ymax = dets[i].bbox.y + dets[i].bbox.h/<span class="hljs-number">2.</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (xmin &lt; <span class="hljs-number">0</span>) xmin = <span class="hljs-number">0</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (ymin &lt; <span class="hljs-number">0</span>) ymin = <span class="hljs-number">0</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (xmax &gt; w) xmax = w;</span><br><span class="line">        <span class="hljs-keyword">if</span> (ymax &gt; h) ymax = h;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; classes; ++j)&#123;</span><br><span class="line">            <span class="hljs-keyword">int</span> <span class="hljs-class"><span class="hljs-keyword">class</span> = <span class="hljs-title">j</span>;</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (dets[i].prob[class]) <span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"%d %d %f %f %f %f %f\n"</span>, id, j+<span class="hljs-number">1</span>, dets[i].prob[class],</span><br><span class="line">                    xmin, ymin, xmax, ymax);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">validate_detector_flip</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *datacfg, <span class="hljs-keyword">char</span> *cfgfile, <span class="hljs-keyword">char</span> *weightfile, <span class="hljs-keyword">char</span> *outfile)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> j;</span><br><span class="line">    <span class="hljs-built_in">list</span> *options = read_data_cfg(datacfg);</span><br><span class="line">    <span class="hljs-keyword">char</span> *valid_images = option_find_str(options, <span class="hljs-string">"valid"</span>, <span class="hljs-string">"data/valid.list"</span>);</span><br><span class="line">    <span class="hljs-keyword">char</span> *name_list = option_find_str(options, <span class="hljs-string">"names"</span>, <span class="hljs-string">"data/names.list"</span>);</span><br><span class="line">    <span class="hljs-keyword">char</span> *prefix = option_find_str(options, <span class="hljs-string">"results"</span>, <span class="hljs-string">"results"</span>);</span><br><span class="line">    <span class="hljs-keyword">char</span> **names = get_labels(name_list);</span><br><span class="line">    <span class="hljs-keyword">char</span> *mapf = option_find_str(options, <span class="hljs-string">"map"</span>, <span class="hljs-number">0</span>);</span><br><span class="line">    <span class="hljs-keyword">int</span> *<span class="hljs-built_in">map</span> = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span> (mapf) <span class="hljs-built_in">map</span> = read_map(mapf);</span><br><span class="line"></span><br><span class="line">    network *net = load_network(cfgfile, weightfile, <span class="hljs-number">0</span>);</span><br><span class="line">    set_batch_network(net, <span class="hljs-number">2</span>);</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Learning Rate: %g, Momentum: %g, Decay: %g\n"</span>, net-&gt;learning_rate, net-&gt;momentum, net-&gt;decay);</span><br><span class="line">    srand(time(<span class="hljs-number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="hljs-built_in">list</span> *plist = get_paths(valid_images);</span><br><span class="line">    <span class="hljs-keyword">char</span> **paths = (<span class="hljs-keyword">char</span> **)list_to_array(plist);</span><br><span class="line"></span><br><span class="line">    layer l = net-&gt;layers[net-&gt;n<span class="hljs-number">-1</span>];</span><br><span class="line">    <span class="hljs-keyword">int</span> classes = l.classes;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">char</span> buff[<span class="hljs-number">1024</span>];</span><br><span class="line">    <span class="hljs-keyword">char</span> *type = option_find_str(options, <span class="hljs-string">"eval"</span>, <span class="hljs-string">"voc"</span>);</span><br><span class="line">    FILE *fp = <span class="hljs-number">0</span>;</span><br><span class="line">    FILE **fps = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> coco = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> imagenet = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(type, <span class="hljs-string">"coco"</span>))&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span>(!outfile) outfile = <span class="hljs-string">"coco_results"</span>;</span><br><span class="line">        <span class="hljs-built_in">snprintf</span>(buff, <span class="hljs-number">1024</span>, <span class="hljs-string">"%s/%s.json"</span>, prefix, outfile);</span><br><span class="line">        fp = fopen(buff, <span class="hljs-string">"w"</span>);</span><br><span class="line">        <span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"[\n"</span>);</span><br><span class="line">        coco = <span class="hljs-number">1</span>;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(type, <span class="hljs-string">"imagenet"</span>))&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span>(!outfile) outfile = <span class="hljs-string">"imagenet-detection"</span>;</span><br><span class="line">        <span class="hljs-built_in">snprintf</span>(buff, <span class="hljs-number">1024</span>, <span class="hljs-string">"%s/%s.txt"</span>, prefix, outfile);</span><br><span class="line">        fp = fopen(buff, <span class="hljs-string">"w"</span>);</span><br><span class="line">        imagenet = <span class="hljs-number">1</span>;</span><br><span class="line">        classes = <span class="hljs-number">200</span>;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span>(!outfile) outfile = <span class="hljs-string">"comp4_det_test_"</span>;</span><br><span class="line">        fps = <span class="hljs-built_in">calloc</span>(classes, <span class="hljs-keyword">sizeof</span>(FILE *));</span><br><span class="line">        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; classes; ++j)&#123;</span><br><span class="line">            <span class="hljs-built_in">snprintf</span>(buff, <span class="hljs-number">1024</span>, <span class="hljs-string">"%s/%s%s.txt"</span>, prefix, outfile, names[j]);</span><br><span class="line">            fps[j] = fopen(buff, <span class="hljs-string">"w"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> m = plist-&gt;size;</span><br><span class="line">    <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> t;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">float</span> thresh = <span class="hljs-number">.95</span>;</span><br><span class="line">    <span class="hljs-keyword">float</span> nms = <span class="hljs-number">.45</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> nthreads = <span class="hljs-number">4</span>;</span><br><span class="line">    image *val = <span class="hljs-built_in">calloc</span>(nthreads, <span class="hljs-keyword">sizeof</span>(image));</span><br><span class="line">    image *val_resized = <span class="hljs-built_in">calloc</span>(nthreads, <span class="hljs-keyword">sizeof</span>(image));</span><br><span class="line">    image *buf = <span class="hljs-built_in">calloc</span>(nthreads, <span class="hljs-keyword">sizeof</span>(image));</span><br><span class="line">    image *buf_resized = <span class="hljs-built_in">calloc</span>(nthreads, <span class="hljs-keyword">sizeof</span>(image));</span><br><span class="line">    <span class="hljs-keyword">pthread_t</span> *thr = <span class="hljs-built_in">calloc</span>(nthreads, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">pthread_t</span>));</span><br><span class="line"></span><br><span class="line">    image input = make_image(net-&gt;w, net-&gt;h, net-&gt;c*<span class="hljs-number">2</span>);</span><br><span class="line"></span><br><span class="line">    load_args args = &#123;<span class="hljs-number">0</span>&#125;;</span><br><span class="line">    args.w = net-&gt;w;</span><br><span class="line">    args.h = net-&gt;h;</span><br><span class="line">    <span class="hljs-comment">//args.type = IMAGE_DATA;</span></span><br><span class="line">    args.type = LETTERBOX_DATA;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">for</span>(t = <span class="hljs-number">0</span>; t &lt; nthreads; ++t)&#123;</span><br><span class="line">        args.path = paths[i+t];</span><br><span class="line">        args.im = &amp;buf[t];</span><br><span class="line">        args.resized = &amp;buf_resized[t];</span><br><span class="line">        thr[t] = load_data_in_thread(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">double</span> start = what_time_is_it_now();</span><br><span class="line">    <span class="hljs-keyword">for</span>(i = nthreads; i &lt; m+nthreads; i += nthreads)&#123;</span><br><span class="line">        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"%d\n"</span>, i);</span><br><span class="line">        <span class="hljs-keyword">for</span>(t = <span class="hljs-number">0</span>; t &lt; nthreads &amp;&amp; i+t-nthreads &lt; m; ++t)&#123;</span><br><span class="line">            pthread_join(thr[t], <span class="hljs-number">0</span>);</span><br><span class="line">            val[t] = buf[t];</span><br><span class="line">            val_resized[t] = buf_resized[t];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">for</span>(t = <span class="hljs-number">0</span>; t &lt; nthreads &amp;&amp; i+t &lt; m; ++t)&#123;</span><br><span class="line">            args.path = paths[i+t];</span><br><span class="line">            args.im = &amp;buf[t];</span><br><span class="line">            args.resized = &amp;buf_resized[t];</span><br><span class="line">            thr[t] = load_data_in_thread(args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">for</span>(t = <span class="hljs-number">0</span>; t &lt; nthreads &amp;&amp; i+t-nthreads &lt; m; ++t)&#123;</span><br><span class="line">            <span class="hljs-keyword">char</span> *path = paths[i+t-nthreads];</span><br><span class="line">            <span class="hljs-keyword">char</span> *id = basecfg(path);</span><br><span class="line">            copy_cpu(net-&gt;w*net-&gt;h*net-&gt;c, val_resized[t].data, <span class="hljs-number">1</span>, input.data, <span class="hljs-number">1</span>);</span><br><span class="line">            flip_image(val_resized[t]);</span><br><span class="line">            copy_cpu(net-&gt;w*net-&gt;h*net-&gt;c, val_resized[t].data, <span class="hljs-number">1</span>, input.data + net-&gt;w*net-&gt;h*net-&gt;c, <span class="hljs-number">1</span>);</span><br><span class="line"></span><br><span class="line">            network_predict(net, input.data);</span><br><span class="line">            <span class="hljs-keyword">int</span> w = val[t].w;</span><br><span class="line">            <span class="hljs-keyword">int</span> h = val[t].h;</span><br><span class="line">            <span class="hljs-keyword">int</span> num = <span class="hljs-number">0</span>;</span><br><span class="line">            detection *dets = get_network_boxes(net, w, h, thresh, <span class="hljs-number">.5</span>, <span class="hljs-built_in">map</span>, <span class="hljs-number">0</span>, &amp;num);</span><br><span class="line">            <span class="hljs-keyword">if</span> (nms) do_nms_sort(dets, num, classes, nms);</span><br><span class="line">            <span class="hljs-keyword">if</span> (coco)&#123;</span><br><span class="line">                print_cocos(fp, path, dets, num, classes, w, h);</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (imagenet)&#123;</span><br><span class="line">                print_imagenet_detections(fp, i+t-nthreads+<span class="hljs-number">1</span>, dets, num, classes, w, h);</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                print_detector_detections(fps, id, dets, num, classes, w, h);</span><br><span class="line">            &#125;</span><br><span class="line">            free_detections(dets, num);</span><br><span class="line">            <span class="hljs-built_in">free</span>(id);</span><br><span class="line">            free_image(val[t]);</span><br><span class="line">            free_image(val_resized[t]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; classes; ++j)&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span>(fps) fclose(fps[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span>(coco)&#123;</span><br><span class="line">        fseek(fp, <span class="hljs-number">-2</span>, SEEK_CUR); </span><br><span class="line">        <span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"\n]\n"</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Total Detection Time: %f Seconds\n"</span>, what_time_is_it_now() - start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">validate_detector</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *datacfg, <span class="hljs-keyword">char</span> *cfgfile, <span class="hljs-keyword">char</span> *weightfile, <span class="hljs-keyword">char</span> *outfile)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">int</span> j;</span><br><span class="line">    <span class="hljs-built_in">list</span> *options = read_data_cfg(datacfg);</span><br><span class="line">    <span class="hljs-keyword">char</span> *valid_images = option_find_str(options, <span class="hljs-string">"valid"</span>, <span class="hljs-string">"data/valid.list"</span>);</span><br><span class="line">    <span class="hljs-keyword">char</span> *name_list = option_find_str(options, <span class="hljs-string">"names"</span>, <span class="hljs-string">"data/voc.names"</span>);</span><br><span class="line">    <span class="hljs-keyword">char</span> *prefix = option_find_str(options, <span class="hljs-string">"results"</span>, <span class="hljs-string">"results"</span>);</span><br><span class="line">    <span class="hljs-keyword">char</span> **names = get_labels(name_list);</span><br><span class="line">    <span class="hljs-keyword">char</span> *mapf = option_find_str(options, <span class="hljs-string">"map"</span>, <span class="hljs-number">0</span>);</span><br><span class="line">    <span class="hljs-keyword">int</span> *<span class="hljs-built_in">map</span> = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span> (mapf) <span class="hljs-built_in">map</span> = read_map(mapf);</span><br><span class="line"></span><br><span class="line">    network *net = load_network(cfgfile, weightfile, <span class="hljs-number">0</span>);</span><br><span class="line">    set_batch_network(net, <span class="hljs-number">1</span>);</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Learning Rate: %g, Momentum: %g, Decay: %g\n"</span>, net-&gt;learning_rate, net-&gt;momentum, net-&gt;decay);</span><br><span class="line">    srand(time(<span class="hljs-number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="hljs-built_in">list</span> *plist = get_paths(valid_images);</span><br><span class="line">    <span class="hljs-keyword">char</span> **paths = (<span class="hljs-keyword">char</span> **)list_to_array(plist);</span><br><span class="line"></span><br><span class="line">    layer l = net-&gt;layers[net-&gt;n<span class="hljs-number">-1</span>];</span><br><span class="line">    <span class="hljs-keyword">int</span> classes = l.classes;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">char</span> buff[<span class="hljs-number">1024</span>];</span><br><span class="line">    <span class="hljs-keyword">char</span> *type = option_find_str(options, <span class="hljs-string">"eval"</span>, <span class="hljs-string">"voc"</span>);</span><br><span class="line">    FILE *fp = <span class="hljs-number">0</span>;</span><br><span class="line">    FILE **fps = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> coco = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> imagenet = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(type, <span class="hljs-string">"coco"</span>))&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span>(!outfile) outfile = <span class="hljs-string">"coco_results"</span>;</span><br><span class="line">        <span class="hljs-built_in">snprintf</span>(buff, <span class="hljs-number">1024</span>, <span class="hljs-string">"%s/%s.json"</span>, prefix, outfile);</span><br><span class="line">        fp = fopen(buff, <span class="hljs-string">"w"</span>);</span><br><span class="line">        <span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"[\n"</span>);</span><br><span class="line">        coco = <span class="hljs-number">1</span>;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(type, <span class="hljs-string">"imagenet"</span>))&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span>(!outfile) outfile = <span class="hljs-string">"imagenet-detection"</span>;</span><br><span class="line">        <span class="hljs-built_in">snprintf</span>(buff, <span class="hljs-number">1024</span>, <span class="hljs-string">"%s/%s.txt"</span>, prefix, outfile);</span><br><span class="line">        fp = fopen(buff, <span class="hljs-string">"w"</span>);</span><br><span class="line">        imagenet = <span class="hljs-number">1</span>;</span><br><span class="line">        classes = <span class="hljs-number">200</span>;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span>(!outfile) outfile = <span class="hljs-string">"comp4_det_test_"</span>;</span><br><span class="line">        fps = <span class="hljs-built_in">calloc</span>(classes, <span class="hljs-keyword">sizeof</span>(FILE *));</span><br><span class="line">        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; classes; ++j)&#123;</span><br><span class="line">            <span class="hljs-built_in">snprintf</span>(buff, <span class="hljs-number">1024</span>, <span class="hljs-string">"%s/%s%s.txt"</span>, prefix, outfile, names[j]);</span><br><span class="line">            fps[j] = fopen(buff, <span class="hljs-string">"w"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> m = plist-&gt;size;</span><br><span class="line">    <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> t;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">float</span> thresh = <span class="hljs-number">.95</span>;</span><br><span class="line">    <span class="hljs-keyword">float</span> nms = <span class="hljs-number">.45</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> nthreads = <span class="hljs-number">4</span>;</span><br><span class="line">    image *val = <span class="hljs-built_in">calloc</span>(nthreads, <span class="hljs-keyword">sizeof</span>(image));</span><br><span class="line">    image *val_resized = <span class="hljs-built_in">calloc</span>(nthreads, <span class="hljs-keyword">sizeof</span>(image));</span><br><span class="line">    image *buf = <span class="hljs-built_in">calloc</span>(nthreads, <span class="hljs-keyword">sizeof</span>(image));</span><br><span class="line">    image *buf_resized = <span class="hljs-built_in">calloc</span>(nthreads, <span class="hljs-keyword">sizeof</span>(image));</span><br><span class="line">    <span class="hljs-keyword">pthread_t</span> *thr = <span class="hljs-built_in">calloc</span>(nthreads, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">pthread_t</span>));</span><br><span class="line"></span><br><span class="line">    load_args args = &#123;<span class="hljs-number">0</span>&#125;;</span><br><span class="line">    args.w = net-&gt;w;</span><br><span class="line">    args.h = net-&gt;h;</span><br><span class="line">    <span class="hljs-comment">//args.type = IMAGE_DATA;</span></span><br><span class="line">    args.type = LETTERBOX_DATA;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">for</span>(t = <span class="hljs-number">0</span>; t &lt; nthreads; ++t)&#123;</span><br><span class="line">        args.path = paths[i+t];</span><br><span class="line">        args.im = &amp;buf[t];</span><br><span class="line">        args.resized = &amp;buf_resized[t];</span><br><span class="line">        thr[t] = load_data_in_thread(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">double</span> start = what_time_is_it_now();</span><br><span class="line">    <span class="hljs-keyword">for</span>(i = nthreads; i &lt; m+nthreads; i += nthreads)&#123;</span><br><span class="line">        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"%d\n"</span>, i);</span><br><span class="line">        <span class="hljs-keyword">for</span>(t = <span class="hljs-number">0</span>; t &lt; nthreads &amp;&amp; i+t-nthreads &lt; m; ++t)&#123;</span><br><span class="line">            pthread_join(thr[t], <span class="hljs-number">0</span>);</span><br><span class="line">            val[t] = buf[t];</span><br><span class="line">            val_resized[t] = buf_resized[t];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">for</span>(t = <span class="hljs-number">0</span>; t &lt; nthreads &amp;&amp; i+t &lt; m; ++t)&#123;</span><br><span class="line">            args.path = paths[i+t];</span><br><span class="line">            args.im = &amp;buf[t];</span><br><span class="line">            args.resized = &amp;buf_resized[t];</span><br><span class="line">            thr[t] = load_data_in_thread(args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">for</span>(t = <span class="hljs-number">0</span>; t &lt; nthreads &amp;&amp; i+t-nthreads &lt; m; ++t)&#123;</span><br><span class="line">            <span class="hljs-keyword">char</span> *path = paths[i+t-nthreads];</span><br><span class="line">            <span class="hljs-keyword">char</span> *id = basecfg(path);</span><br><span class="line">            <span class="hljs-keyword">float</span> *X = val_resized[t].data;</span><br><span class="line">            network_predict(net, X);</span><br><span class="line">            <span class="hljs-keyword">int</span> w = val[t].w;</span><br><span class="line">            <span class="hljs-keyword">int</span> h = val[t].h;</span><br><span class="line">            <span class="hljs-keyword">int</span> nboxes = <span class="hljs-number">0</span>;</span><br><span class="line">            detection *dets = get_network_boxes(net, w, h, thresh, <span class="hljs-number">.5</span>, <span class="hljs-built_in">map</span>, <span class="hljs-number">0</span>, &amp;nboxes);</span><br><span class="line">            <span class="hljs-keyword">if</span> (nms) do_nms_sort(dets, nboxes, classes, nms);</span><br><span class="line">            <span class="hljs-keyword">if</span> (coco)&#123;</span><br><span class="line">                print_cocos(fp, path, dets, nboxes, classes, w, h);</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (imagenet)&#123;</span><br><span class="line">                print_imagenet_detections(fp, i+t-nthreads+<span class="hljs-number">1</span>, dets, nboxes, classes, w, h);</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                print_detector_detections(fps, id, dets, nboxes, classes, w, h);</span><br><span class="line">            &#125;</span><br><span class="line">            free_detections(dets, nboxes);</span><br><span class="line">            <span class="hljs-built_in">free</span>(id);</span><br><span class="line">            free_image(val[t]);</span><br><span class="line"></span><br><span class="line">            free_image(val_resized[t]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; classes; ++j)&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span>(fps) fclose(fps[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span>(coco)&#123;</span><br><span class="line">        fseek(fp, <span class="hljs-number">-2</span>, SEEK_CUR); </span><br><span class="line">        <span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"\n]\n"</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Total Detection Time: %f Seconds\n"</span>, what_time_is_it_now() - start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">validate_detector_recall</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *datacfg, <span class="hljs-keyword">char</span> *cfgfile, <span class="hljs-keyword">char</span> *weightfile)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    network *net = load_network(cfgfile, weightfile, <span class="hljs-number">0</span>);</span><br><span class="line">    set_batch_network(net, <span class="hljs-number">1</span>);</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Learning Rate: %g, Momentum: %g, Decay: %g\n"</span>, net-&gt;learning_rate, net-&gt;momentum, net-&gt;decay);</span><br><span class="line">    srand(time(<span class="hljs-number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="hljs-built_in">list</span> *options = read_data_cfg(datacfg);</span><br><span class="line">    <span class="hljs-keyword">char</span> *valid_images = option_find_str(options, <span class="hljs-string">"valid"</span>, <span class="hljs-string">"data/valid.list"</span>);</span><br><span class="line">    <span class="hljs-built_in">list</span> *plist = get_paths(valid_images);</span><br><span class="line">    <span class="hljs-keyword">char</span> **paths = (<span class="hljs-keyword">char</span> **)list_to_array(plist);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//layer l = net-&gt;layers[net-&gt;n-1];</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> j, k;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> m = plist-&gt;size;    <span class="hljs-comment">//测试的图片总数</span></span><br><span class="line">    <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">float</span> thresh = <span class="hljs-number">.95</span>;</span><br><span class="line">    <span class="hljs-keyword">float</span> iou_thresh = <span class="hljs-number">.5</span>;</span><br><span class="line">    <span class="hljs-keyword">float</span> nms = <span class="hljs-number">.4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> total = <span class="hljs-number">0</span>;      <span class="hljs-comment">//实际有多少个bbox</span></span><br><span class="line">    <span class="hljs-keyword">int</span> correct = <span class="hljs-number">0</span>;    <span class="hljs-comment">//正确识别出了多少个bbox</span></span><br><span class="line">    <span class="hljs-keyword">int</span> proposals = <span class="hljs-number">0</span>;  <span class="hljs-comment">//测试集预测的bbox总数</span></span><br><span class="line">    <span class="hljs-keyword">float</span> avg_iou = <span class="hljs-number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">//printf("l.w*l.h*l.n = %d\n",l.w*l.h*l.n);</span></span><br><span class="line">    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; m; ++i)&#123;</span><br><span class="line">        <span class="hljs-keyword">char</span> *path = paths[i];</span><br><span class="line">        image orig = load_image_color(path, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</span><br><span class="line">        image sized = resize_image(orig, net-&gt;w, net-&gt;h);</span><br><span class="line">        <span class="hljs-keyword">char</span> *id = basecfg(path);</span><br><span class="line">        network_predict(net, sized.data);</span><br><span class="line">        <span class="hljs-keyword">int</span> nboxes = <span class="hljs-number">0</span>;</span><br><span class="line">        detection *dets = get_network_boxes(net, sized.w, sized.h, thresh, <span class="hljs-number">.5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;nboxes);</span><br><span class="line">        <span class="hljs-keyword">if</span> (nms) do_nms_obj(dets, nboxes, <span class="hljs-number">1</span>, nms);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">char</span> labelpath[<span class="hljs-number">4096</span>];</span><br><span class="line">        find_replace(path, <span class="hljs-string">"images"</span>, <span class="hljs-string">"labels"</span>, labelpath);</span><br><span class="line">        find_replace(labelpath, <span class="hljs-string">"JPEGImages"</span>, <span class="hljs-string">"labels"</span>, labelpath);</span><br><span class="line">        find_replace(labelpath, <span class="hljs-string">".jpg"</span>, <span class="hljs-string">".txt"</span>, labelpath);</span><br><span class="line">        find_replace(labelpath, <span class="hljs-string">".JPEG"</span>, <span class="hljs-string">".txt"</span>, labelpath);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">int</span> num_labels = <span class="hljs-number">0</span>;     <span class="hljs-comment">//测试集实际的标注框数量</span></span><br><span class="line">        box_label *truth = read_boxes(labelpath, &amp;num_labels);</span><br><span class="line">        <span class="hljs-keyword">for</span>(k = <span class="hljs-number">0</span>; k &lt; nboxes; ++k)&#123;</span><br><span class="line">            <span class="hljs-keyword">if</span>(dets[k].objectness &gt; thresh)&#123;</span><br><span class="line">                ++proposals;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; num_labels; ++j) &#123;</span><br><span class="line">            ++total;</span><br><span class="line">            box t = &#123;truth[j].x, truth[j].y, truth[j].w, truth[j].h&#125;;</span><br><span class="line">            <span class="hljs-comment">//printf("truth x=%f, y=%f, w=%f,h=%f\n",truth[j].x,truth[j].y,truth[j].w,truth[j].h);</span></span><br><span class="line">            <span class="hljs-keyword">float</span> best_iou = <span class="hljs-number">0</span>;</span><br><span class="line">            <span class="hljs-comment">//对每一个标注的框</span></span><br><span class="line">            <span class="hljs-keyword">for</span>(k = <span class="hljs-number">0</span>; k &lt; nboxes; ++k)&#123;</span><br><span class="line">            <span class="hljs-comment">//for(k = 0; k &lt; l.w*l.h*l.n; ++k)&#123;</span></span><br><span class="line">                <span class="hljs-keyword">float</span> iou = box_iou(dets[k].bbox, t);</span><br><span class="line">                <span class="hljs-comment">//printf("predict=%f iou=%f x=%f, y=%f, w=%f,h=%f\n",dets[k].objectness,iou,dets[k].bbox.x,dets[k].bbox.y,dets[k].bbox.w,dets[k].bbox.h);</span></span><br><span class="line">                <span class="hljs-keyword">if</span>(dets[k].objectness &gt; thresh &amp;&amp; iou &gt; best_iou)&#123;</span><br><span class="line">                    best_iou = iou;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-comment">//printf("best_iou=%f\n",best_iou);</span></span><br><span class="line">            avg_iou += best_iou;</span><br><span class="line">            <span class="hljs-keyword">if</span>(best_iou &gt; iou_thresh)&#123;</span><br><span class="line">                ++correct;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"%5d %5d %5d\tRPs/Img: %.2f\tIOU: %.2f%%\tRecall:%.2f%%\n"</span>, i, correct, total, (<span class="hljs-keyword">float</span>)proposals/(i+<span class="hljs-number">1</span>), avg_iou*<span class="hljs-number">100</span>/total, <span class="hljs-number">100.</span>*correct/total);</span><br><span class="line">        <span class="hljs-built_in">free</span>(id);</span><br><span class="line">        free_image(orig);</span><br><span class="line">        free_image(sized);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test_detector</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *datacfg, <span class="hljs-keyword">char</span> *cfgfile, <span class="hljs-keyword">char</span> *weightfile, <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">float</span> thresh, <span class="hljs-keyword">float</span> hier_thresh, <span class="hljs-keyword">char</span> *outfile, <span class="hljs-keyword">int</span> fullscreen)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-built_in">list</span> *options = read_data_cfg(datacfg); <span class="hljs-comment">//options存储分类的标签等基本训练信息</span></span><br><span class="line">    <span class="hljs-keyword">char</span> *name_list = option_find_str(options, <span class="hljs-string">"names"</span>, <span class="hljs-string">"data/names.list"</span>); <span class="hljs-comment">//抽取标签名称</span></span><br><span class="line">    <span class="hljs-keyword">char</span> **names = get_labels(name_list);</span><br><span class="line"></span><br><span class="line">    image **alphabet = load_alphabet(); <span class="hljs-comment">//加载位于data/labels下的字符图片，用于显示矩形框名称</span></span><br><span class="line">    network *net = load_network(cfgfile, weightfile, <span class="hljs-number">0</span>);    <span class="hljs-comment">//用netweork.h中自定义的network结构体存储模型文件,函数位于parser.c</span></span><br><span class="line">    set_batch_network(net, <span class="hljs-number">1</span>);</span><br><span class="line">    srand(<span class="hljs-number">2222222</span>);</span><br><span class="line">    <span class="hljs-keyword">double</span> start_time;</span><br><span class="line">    <span class="hljs-keyword">double</span> end_time;</span><br><span class="line">    <span class="hljs-keyword">double</span> img_time;</span><br><span class="line">    <span class="hljs-keyword">double</span> sum_time=<span class="hljs-number">0.0</span>;</span><br><span class="line">    <span class="hljs-keyword">char</span> buff[<span class="hljs-number">256</span>];</span><br><span class="line">    <span class="hljs-keyword">char</span> *input = buff;</span><br><span class="line">    <span class="hljs-keyword">float</span> nms=<span class="hljs-number">.45</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;</span><br><span class="line">        <span class="hljs-comment">//读取结构对应的权重文件</span></span><br><span class="line">        <span class="hljs-keyword">if</span>(filename)&#123;</span><br><span class="line">            <span class="hljs-built_in">strncpy</span>(input, filename, <span class="hljs-number">256</span>);</span><br><span class="line">            image im = load_image_color(input,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);</span><br><span class="line">            image sized = letterbox_image(im, net-&gt;w, net-&gt;h);  <span class="hljs-comment">//输入图片大小经过resize至输入大小</span></span><br><span class="line">            <span class="hljs-comment">//image sized = resize_image(im, net-&gt;w, net-&gt;h);</span></span><br><span class="line">            <span class="hljs-comment">//image sized2 = resize_max(im, net-&gt;w);</span></span><br><span class="line">            <span class="hljs-comment">//image sized = crop_image(sized2, -((net-&gt;w - sized2.w)/2), -((net-&gt;h - sized2.h)/2), net-&gt;w, net-&gt;h);</span></span><br><span class="line">            <span class="hljs-comment">//resize_network(net, sized.w, sized.h);</span></span><br><span class="line">            layer l = net-&gt;layers[net-&gt;n<span class="hljs-number">-1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">float</span> *X = sized.data;  <span class="hljs-comment">//X指向图片的data元素，即图片像素</span></span><br><span class="line">            start_time=what_time_is_it_now();</span><br><span class="line">            network_predict(net, X);    <span class="hljs-comment">//network_predict函数负责预测当前图片的数据X</span></span><br><span class="line">            end_time=what_time_is_it_now();</span><br><span class="line">            img_time= end_time - start_time;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s: Predicted in %f seconds.\n"</span>, input, img_time);</span><br><span class="line">            <span class="hljs-keyword">int</span> nboxes = <span class="hljs-number">0</span>;</span><br><span class="line">            detection *dets = get_network_boxes(net, im.w, im.h, thresh, hier_thresh, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;nboxes);</span><br><span class="line">            <span class="hljs-comment">//printf("%d\n", nboxes);</span></span><br><span class="line">            <span class="hljs-comment">//if (nms) do_nms_obj(boxes, probs, l.w*l.h*l.n, l.classes, nms);</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (nms) do_nms_sort(dets, nboxes, l.classes, nms);</span><br><span class="line">            draw_detections(im, dets, nboxes, thresh, names, alphabet, l.classes);</span><br><span class="line">            free_detections(dets, nboxes);</span><br><span class="line">            <span class="hljs-keyword">if</span>(outfile)</span><br><span class="line">             &#123;</span><br><span class="line">                save_image(im, outfile);</span><br><span class="line">             &#125;</span><br><span class="line">            <span class="hljs-keyword">else</span>&#123;</span><br><span class="line">                <span class="hljs-comment">//save_image(im, "predictions");</span></span><br><span class="line">                <span class="hljs-keyword">char</span> image[<span class="hljs-number">2048</span>];</span><br><span class="line">                <span class="hljs-built_in">sprintf</span>(image,<span class="hljs-string">"./data/predict/%s"</span>,GetFilename(filename));</span><br><span class="line">                save_image(im,image);</span><br><span class="line">                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"predict %s successfully!\n"</span>,GetFilename(filename));</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> OPENCV</span></span><br><span class="line">                cvNamedWindow(<span class="hljs-string">"predictions"</span>, CV_WINDOW_NORMAL);</span><br><span class="line">                <span class="hljs-keyword">if</span>(fullscreen)&#123;</span><br><span class="line">                cvSetWindowProperty(<span class="hljs-string">"predictions"</span>, CV_WND_PROP_FULLSCREEN, CV_WINDOW_FULLSCREEN);</span><br><span class="line">                &#125;</span><br><span class="line">                show_image(im, <span class="hljs-string">"predictions"</span>);</span><br><span class="line">                cvWaitKey(<span class="hljs-number">0</span>);</span><br><span class="line">                cvDestroyAllWindows();</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line">            free_image(im);</span><br><span class="line">            free_image(sized);</span><br><span class="line">            <span class="hljs-keyword">if</span> (filename) <span class="hljs-keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Enter Image Path: "</span>);</span><br><span class="line">            fflush(<span class="hljs-built_in">stdout</span>);</span><br><span class="line">            input = fgets(input, <span class="hljs-number">256</span>, <span class="hljs-built_in">stdin</span>);</span><br><span class="line">            <span class="hljs-keyword">if</span>(!input) <span class="hljs-keyword">return</span>;</span><br><span class="line">            strtok(input, <span class="hljs-string">"\n"</span>);</span><br><span class="line">    </span><br><span class="line">            <span class="hljs-built_in">list</span> *plist = get_paths(input);</span><br><span class="line">            <span class="hljs-keyword">char</span> **paths = (<span class="hljs-keyword">char</span> **)list_to_array(plist);</span><br><span class="line">            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Start Testing!\n"</span>);</span><br><span class="line">            <span class="hljs-keyword">int</span> m = plist-&gt;size;</span><br><span class="line">            <span class="hljs-keyword">if</span>(access(<span class="hljs-string">"/aseit-data/XCM_WorkSpace/darknet_test/darknet/test_out"</span>,<span class="hljs-number">0</span>)==<span class="hljs-number">-1</span>)<span class="hljs-comment">//修改成自己的路径</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="hljs-keyword">if</span> (mkdir(<span class="hljs-string">"/aseit-data/XCM_WorkSpace/darknet_test/darknet/test_out"</span>,<span class="hljs-number">0777</span>))<span class="hljs-comment">//修改成自己的路径</span></span><br><span class="line">               &#123;</span><br><span class="line">                 <span class="hljs-built_in">printf</span>(<span class="hljs-string">"creat file bag failed!!!"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; m; ++i)&#123;</span><br><span class="line">                <span class="hljs-keyword">char</span> *path = paths[i];</span><br><span class="line">                image im = load_image_color(path,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);</span><br><span class="line">                image sized = letterbox_image(im, net-&gt;w, net-&gt;h);  <span class="hljs-comment">//输入图片大小经过resize至输入大小</span></span><br><span class="line">                <span class="hljs-comment">//image sized = resize_image(im, net-&gt;w, net-&gt;h);</span></span><br><span class="line">                <span class="hljs-comment">//image sized2 = resize_max(im, net-&gt;w);</span></span><br><span class="line">                <span class="hljs-comment">//image sized = crop_image(sized2, -((net-&gt;w - sized2.w)/2), -((net-&gt;h - sized2.h)/2), net-&gt;w, net-&gt;h);</span></span><br><span class="line">                <span class="hljs-comment">//resize_network(net, sized.w, sized.h);</span></span><br><span class="line">                layer l = net-&gt;layers[net-&gt;n<span class="hljs-number">-1</span>];</span><br><span class="line"></span><br><span class="line">                <span class="hljs-keyword">float</span> *X = sized.data;  <span class="hljs-comment">//X指向图片的data元素，即图片像素</span></span><br><span class="line">                start_time = what_time_is_it_now();</span><br><span class="line">                network_predict(net, X);    <span class="hljs-comment">//network_predict函数负责预测当前图片的数据X</span></span><br><span class="line">                end_time = what_time_is_it_now();</span><br><span class="line">                img_time = end_time - start_time;</span><br><span class="line">                sum_time = sum_time+img_time;</span><br><span class="line">                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Try Very Hard:"</span>);</span><br><span class="line">                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s: Predicted in %f seconds.\n"</span>, path, img_time);</span><br><span class="line">                <span class="hljs-keyword">int</span> nboxes = <span class="hljs-number">0</span>;</span><br><span class="line">                detection *dets = get_network_boxes(net, im.w, im.h, thresh, hier_thresh, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;nboxes);</span><br><span class="line">                <span class="hljs-comment">//printf("%d\n", nboxes);</span></span><br><span class="line">                <span class="hljs-comment">//if (nms) do_nms_obj(boxes, probs, l.w*l.h*l.n, l.classes, nms);</span></span><br><span class="line">                <span class="hljs-keyword">if</span> (nms) do_nms_sort(dets, nboxes, l.classes, nms);</span><br><span class="line">                draw_detections(im, dets, nboxes, thresh, names, alphabet, l.classes);</span><br><span class="line">                free_detections(dets, nboxes);</span><br><span class="line">                <span class="hljs-keyword">if</span>(outfile)&#123;</span><br><span class="line">                    save_image(im, outfile);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="hljs-keyword">else</span>&#123;</span><br><span class="line">                    <span class="hljs-keyword">char</span> b[<span class="hljs-number">2048</span>];</span><br><span class="line">                    <span class="hljs-built_in">sprintf</span>(b,<span class="hljs-string">"/aseit-data/XCM_WorkSpace/darknet_test/darknet/test_out/%s"</span>,GetFilename(path));<span class="hljs-comment">//修改成自己的路径</span></span><br><span class="line">                     </span><br><span class="line">                    save_image(im, b);</span><br><span class="line">                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"save %s successfully!\n"</span>,GetFilename(path));</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> OPENCV</span></span><br><span class="line">                    cvNamedWindow(<span class="hljs-string">"predictions"</span>, CV_WINDOW_NORMAL);</span><br><span class="line">                    <span class="hljs-keyword">if</span>(fullscreen)&#123;</span><br><span class="line">                        cvSetWindowProperty(<span class="hljs-string">"predictions"</span>, CV_WND_PROP_FULLSCREEN, CV_WINDOW_FULLSCREEN);</span><br><span class="line">                    &#125;</span><br><span class="line">                    show_image(im, <span class="hljs-string">"predictions"</span>);</span><br><span class="line">                    cvWaitKey(<span class="hljs-number">0</span>);</span><br><span class="line">                    cvDestroyAllWindows();</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        free_image(im);</span><br><span class="line">        free_image(sized);</span><br><span class="line">        <span class="hljs-keyword">if</span> (filename) <span class="hljs-keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"fps: %.2f   totall image %d\n"</span>,(<span class="hljs-keyword">float</span>)m/sum_time,m);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">void test_detector(char *datacfg, char *cfgfile, char *weightfile, char *filename, float thresh, float hier_thresh, char *outfile, int fullscreen)</span></span><br><span class="line"><span class="hljs-comment">&#123;</span></span><br><span class="line"><span class="hljs-comment">    list *options = read_data_cfg(datacfg);</span></span><br><span class="line"><span class="hljs-comment">    char *name_list = option_find_str(options, "names", "data/names.list");</span></span><br><span class="line"><span class="hljs-comment">    char **names = get_labels(name_list);</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    image **alphabet = load_alphabet();</span></span><br><span class="line"><span class="hljs-comment">    network *net = load_network(cfgfile, weightfile, 0);</span></span><br><span class="line"><span class="hljs-comment">    set_batch_network(net, 1);</span></span><br><span class="line"><span class="hljs-comment">    srand(2222222);</span></span><br><span class="line"><span class="hljs-comment">    double time;</span></span><br><span class="line"><span class="hljs-comment">    char buff[256];</span></span><br><span class="line"><span class="hljs-comment">    char *input = buff;</span></span><br><span class="line"><span class="hljs-comment">    float nms=.45;</span></span><br><span class="line"><span class="hljs-comment">    while(1)&#123;</span></span><br><span class="line"><span class="hljs-comment">        if(filename)&#123;</span></span><br><span class="line"><span class="hljs-comment">            strncpy(input, filename, 256);</span></span><br><span class="line"><span class="hljs-comment">        &#125; else &#123;</span></span><br><span class="line"><span class="hljs-comment">            printf("Enter Image Path: ");</span></span><br><span class="line"><span class="hljs-comment">            fflush(stdout);</span></span><br><span class="line"><span class="hljs-comment">            input = fgets(input, 256, stdin);</span></span><br><span class="line"><span class="hljs-comment">            if(!input) return;</span></span><br><span class="line"><span class="hljs-comment">            strtok(input, "\n");</span></span><br><span class="line"><span class="hljs-comment">        &#125;</span></span><br><span class="line"><span class="hljs-comment">        image im = load_image_color(input,0,0);</span></span><br><span class="line"><span class="hljs-comment">        image sized = letterbox_image(im, net-&gt;w, net-&gt;h);</span></span><br><span class="line"><span class="hljs-comment">        //image sized = resize_image(im, net-&gt;w, net-&gt;h);</span></span><br><span class="line"><span class="hljs-comment">        //image sized2 = resize_max(im, net-&gt;w);</span></span><br><span class="line"><span class="hljs-comment">        //image sized = crop_image(sized2, -((net-&gt;w - sized2.w)/2), -((net-&gt;h - sized2.h)/2), net-&gt;w, net-&gt;h);</span></span><br><span class="line"><span class="hljs-comment">        //resize_network(net, sized.w, sized.h);</span></span><br><span class="line"><span class="hljs-comment">        layer l = net-&gt;layers[net-&gt;n-1];</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        float *X = sized.data;</span></span><br><span class="line"><span class="hljs-comment">        time=what_time_is_it_now();</span></span><br><span class="line"><span class="hljs-comment">        network_predict(net, X);</span></span><br><span class="line"><span class="hljs-comment">        printf("%s: Predicted in %f seconds.\n", input, what_time_is_it_now()-time);</span></span><br><span class="line"><span class="hljs-comment">        int nboxes = 0;</span></span><br><span class="line"><span class="hljs-comment">        detection *dets = get_network_boxes(net, im.w, im.h, thresh, hier_thresh, 0, 1, &amp;nboxes);</span></span><br><span class="line"><span class="hljs-comment">        //printf("%d\n", nboxes);</span></span><br><span class="line"><span class="hljs-comment">        //if (nms) do_nms_obj(boxes, probs, l.w*l.h*l.n, l.classes, nms);</span></span><br><span class="line"><span class="hljs-comment">        if (nms) do_nms_sort(dets, nboxes, l.classes, nms);</span></span><br><span class="line"><span class="hljs-comment">        draw_detections(im, dets, nboxes, thresh, names, alphabet, l.classes);</span></span><br><span class="line"><span class="hljs-comment">        free_detections(dets, nboxes);</span></span><br><span class="line"><span class="hljs-comment">        if(outfile)&#123;</span></span><br><span class="line"><span class="hljs-comment">            save_image(im, outfile);</span></span><br><span class="line"><span class="hljs-comment">        &#125;</span></span><br><span class="line"><span class="hljs-comment">        else&#123;</span></span><br><span class="line"><span class="hljs-comment">            save_image(im, "predictions");</span></span><br><span class="line"><span class="hljs-comment">#ifdef OPENCV</span></span><br><span class="line"><span class="hljs-comment">            make_window("predictions", 512, 512, 0);</span></span><br><span class="line"><span class="hljs-comment">            show_image(im, "predictions", 0);</span></span><br><span class="line"><span class="hljs-comment">#endif</span></span><br><span class="line"><span class="hljs-comment">        &#125;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        free_image(im);</span></span><br><span class="line"><span class="hljs-comment">        free_image(sized);</span></span><br><span class="line"><span class="hljs-comment">        if (filename) break;</span></span><br><span class="line"><span class="hljs-comment">    &#125;</span></span><br><span class="line"><span class="hljs-comment">&#125;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">void censor_detector(char *datacfg, char *cfgfile, char *weightfile, int cam_index, const char *filename, int class, float thresh, int skip)</span></span><br><span class="line"><span class="hljs-comment">&#123;</span></span><br><span class="line"><span class="hljs-comment">#ifdef OPENCV</span></span><br><span class="line"><span class="hljs-comment">    char *base = basecfg(cfgfile);</span></span><br><span class="line"><span class="hljs-comment">    network *net = load_network(cfgfile, weightfile, 0);</span></span><br><span class="line"><span class="hljs-comment">    set_batch_network(net, 1);</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    srand(2222222);</span></span><br><span class="line"><span class="hljs-comment">    CvCapture * cap;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    int w = 1280;</span></span><br><span class="line"><span class="hljs-comment">    int h = 720;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    if(filename)&#123;</span></span><br><span class="line"><span class="hljs-comment">        cap = cvCaptureFromFile(filename);</span></span><br><span class="line"><span class="hljs-comment">    &#125;else&#123;</span></span><br><span class="line"><span class="hljs-comment">        cap = cvCaptureFromCAM(cam_index);</span></span><br><span class="line"><span class="hljs-comment">    &#125;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    if(w)&#123;</span></span><br><span class="line"><span class="hljs-comment">        cvSetCaptureProperty(cap, CV_CAP_PROP_FRAME_WIDTH, w);</span></span><br><span class="line"><span class="hljs-comment">    &#125;</span></span><br><span class="line"><span class="hljs-comment">    if(h)&#123;</span></span><br><span class="line"><span class="hljs-comment">        cvSetCaptureProperty(cap, CV_CAP_PROP_FRAME_HEIGHT, h);</span></span><br><span class="line"><span class="hljs-comment">    &#125;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    if(!cap) error("Couldn't connect to webcam.\n");</span></span><br><span class="line"><span class="hljs-comment">    cvNamedWindow(base, CV_WINDOW_NORMAL); </span></span><br><span class="line"><span class="hljs-comment">    cvResizeWindow(base, 512, 512);</span></span><br><span class="line"><span class="hljs-comment">    float fps = 0;</span></span><br><span class="line"><span class="hljs-comment">    int i;</span></span><br><span class="line"><span class="hljs-comment">    float nms = .45;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    while(1)&#123;</span></span><br><span class="line"><span class="hljs-comment">        image in = get_image_from_stream(cap);</span></span><br><span class="line"><span class="hljs-comment">        //image in_s = resize_image(in, net-&gt;w, net-&gt;h);</span></span><br><span class="line"><span class="hljs-comment">        image in_s = letterbox_image(in, net-&gt;w, net-&gt;h);</span></span><br><span class="line"><span class="hljs-comment">        layer l = net-&gt;layers[net-&gt;n-1];</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        float *X = in_s.data;</span></span><br><span class="line"><span class="hljs-comment">        network_predict(net, X);</span></span><br><span class="line"><span class="hljs-comment">        int nboxes = 0;</span></span><br><span class="line"><span class="hljs-comment">        detection *dets = get_network_boxes(net, in.w, in.h, thresh, 0, 0, 0, &amp;nboxes);</span></span><br><span class="line"><span class="hljs-comment">        //if (nms) do_nms_obj(boxes, probs, l.w*l.h*l.n, l.classes, nms);</span></span><br><span class="line"><span class="hljs-comment">        if (nms) do_nms_sort(dets, nboxes, l.classes, nms);</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        for(i = 0; i &lt; nboxes; ++i)&#123;</span></span><br><span class="line"><span class="hljs-comment">            if(dets[i].prob[class] &gt; thresh)&#123;</span></span><br><span class="line"><span class="hljs-comment">                box b = dets[i].bbox;</span></span><br><span class="line"><span class="hljs-comment">                int left  = b.x-b.w/2.;</span></span><br><span class="line"><span class="hljs-comment">                int top   = b.y-b.h/2.;</span></span><br><span class="line"><span class="hljs-comment">                censor_image(in, left, top, b.w, b.h);</span></span><br><span class="line"><span class="hljs-comment">            &#125;</span></span><br><span class="line"><span class="hljs-comment">        &#125;</span></span><br><span class="line"><span class="hljs-comment">        show_image(in, base);</span></span><br><span class="line"><span class="hljs-comment">        cvWaitKey(10);</span></span><br><span class="line"><span class="hljs-comment">        free_detections(dets, nboxes);</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        free_image(in_s);</span></span><br><span class="line"><span class="hljs-comment">        free_image(in);</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        float curr = 0;</span></span><br><span class="line"><span class="hljs-comment">        fps = .9*fps + .1*curr;</span></span><br><span class="line"><span class="hljs-comment">        for(i = 0; i &lt; skip; ++i)&#123;</span></span><br><span class="line"><span class="hljs-comment">            image in = get_image_from_stream(cap);</span></span><br><span class="line"><span class="hljs-comment">            free_image(in);</span></span><br><span class="line"><span class="hljs-comment">        &#125;</span></span><br><span class="line"><span class="hljs-comment">    &#125;</span></span><br><span class="line"><span class="hljs-comment">    #endif</span></span><br><span class="line"><span class="hljs-comment">&#125;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">void extract_detector(char *datacfg, char *cfgfile, char *weightfile, int cam_index, const char *filename, int class, float thresh, int skip)</span></span><br><span class="line"><span class="hljs-comment">&#123;</span></span><br><span class="line"><span class="hljs-comment">#ifdef OPENCV</span></span><br><span class="line"><span class="hljs-comment">    char *base = basecfg(cfgfile);</span></span><br><span class="line"><span class="hljs-comment">    network *net = load_network(cfgfile, weightfile, 0);</span></span><br><span class="line"><span class="hljs-comment">    set_batch_network(net, 1);</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    srand(2222222);</span></span><br><span class="line"><span class="hljs-comment">    CvCapture * cap;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    int w = 1280;</span></span><br><span class="line"><span class="hljs-comment">    int h = 720;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    if(filename)&#123;</span></span><br><span class="line"><span class="hljs-comment">        cap = cvCaptureFromFile(filename);</span></span><br><span class="line"><span class="hljs-comment">    &#125;else&#123;</span></span><br><span class="line"><span class="hljs-comment">        cap = cvCaptureFromCAM(cam_index);</span></span><br><span class="line"><span class="hljs-comment">    &#125;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    if(w)&#123;</span></span><br><span class="line"><span class="hljs-comment">        cvSetCaptureProperty(cap, CV_CAP_PROP_FRAME_WIDTH, w);</span></span><br><span class="line"><span class="hljs-comment">    &#125;</span></span><br><span class="line"><span class="hljs-comment">    if(h)&#123;</span></span><br><span class="line"><span class="hljs-comment">        cvSetCaptureProperty(cap, CV_CAP_PROP_FRAME_HEIGHT, h);</span></span><br><span class="line"><span class="hljs-comment">    &#125;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    if(!cap) error("Couldn't connect to webcam.\n");</span></span><br><span class="line"><span class="hljs-comment">    cvNamedWindow(base, CV_WINDOW_NORMAL); </span></span><br><span class="line"><span class="hljs-comment">    cvResizeWindow(base, 512, 512);</span></span><br><span class="line"><span class="hljs-comment">    float fps = 0;</span></span><br><span class="line"><span class="hljs-comment">    int i;</span></span><br><span class="line"><span class="hljs-comment">    int count = 0;</span></span><br><span class="line"><span class="hljs-comment">    float nms = .45;</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">    while(1)&#123;</span></span><br><span class="line"><span class="hljs-comment">        image in = get_image_from_stream(cap);</span></span><br><span class="line"><span class="hljs-comment">        //image in_s = resize_image(in, net-&gt;w, net-&gt;h);</span></span><br><span class="line"><span class="hljs-comment">        image in_s = letterbox_image(in, net-&gt;w, net-&gt;h);</span></span><br><span class="line"><span class="hljs-comment">        layer l = net-&gt;layers[net-&gt;n-1];</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        show_image(in, base);</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        int nboxes = 0;</span></span><br><span class="line"><span class="hljs-comment">        float *X = in_s.data;</span></span><br><span class="line"><span class="hljs-comment">        network_predict(net, X);</span></span><br><span class="line"><span class="hljs-comment">        detection *dets = get_network_boxes(net, in.w, in.h, thresh, 0, 0, 1, &amp;nboxes);</span></span><br><span class="line"><span class="hljs-comment">        //if (nms) do_nms_obj(boxes, probs, l.w*l.h*l.n, l.classes, nms);</span></span><br><span class="line"><span class="hljs-comment">        if (nms) do_nms_sort(dets, nboxes, l.classes, nms);</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        for(i = 0; i &lt; nboxes; ++i)&#123;</span></span><br><span class="line"><span class="hljs-comment">            if(dets[i].prob[class] &gt; thresh)&#123;</span></span><br><span class="line"><span class="hljs-comment">                box b = dets[i].bbox;</span></span><br><span class="line"><span class="hljs-comment">                int size = b.w*in.w &gt; b.h*in.h ? b.w*in.w : b.h*in.h;</span></span><br><span class="line"><span class="hljs-comment">                int dx  = b.x*in.w-size/2.;</span></span><br><span class="line"><span class="hljs-comment">                int dy  = b.y*in.h-size/2.;</span></span><br><span class="line"><span class="hljs-comment">                image bim = crop_image(in, dx, dy, size, size);</span></span><br><span class="line"><span class="hljs-comment">                char buff[2048];</span></span><br><span class="line"><span class="hljs-comment">                sprintf(buff, "results/extract/%07d", count);</span></span><br><span class="line"><span class="hljs-comment">                ++count;</span></span><br><span class="line"><span class="hljs-comment">                save_image(bim, buff);</span></span><br><span class="line"><span class="hljs-comment">                free_image(bim);</span></span><br><span class="line"><span class="hljs-comment">            &#125;</span></span><br><span class="line"><span class="hljs-comment">        &#125;</span></span><br><span class="line"><span class="hljs-comment">        free_detections(dets, nboxes);</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        free_image(in_s);</span></span><br><span class="line"><span class="hljs-comment">        free_image(in);</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">        float curr = 0;</span></span><br><span class="line"><span class="hljs-comment">        fps = .9*fps + .1*curr;</span></span><br><span class="line"><span class="hljs-comment">        for(i = 0; i &lt; skip; ++i)&#123;</span></span><br><span class="line"><span class="hljs-comment">            image in = get_image_from_stream(cap);</span></span><br><span class="line"><span class="hljs-comment">            free_image(in);</span></span><br><span class="line"><span class="hljs-comment">        &#125;</span></span><br><span class="line"><span class="hljs-comment">    &#125;</span></span><br><span class="line"><span class="hljs-comment">    #endif</span></span><br><span class="line"><span class="hljs-comment">&#125;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">void network_detect(network *net, image im, float thresh, float hier_thresh, float nms, detection *dets)</span></span><br><span class="line"><span class="hljs-comment">&#123;</span></span><br><span class="line"><span class="hljs-comment">    network_predict_image(net, im);</span></span><br><span class="line"><span class="hljs-comment">    layer l = net-&gt;layers[net-&gt;n-1];</span></span><br><span class="line"><span class="hljs-comment">    int nboxes = num_boxes(net);</span></span><br><span class="line"><span class="hljs-comment">    fill_network_boxes(net, im.w, im.h, thresh, hier_thresh, 0, 0, dets);</span></span><br><span class="line"><span class="hljs-comment">    if (nms) do_nms_sort(dets, nboxes, l.classes, nms);</span></span><br><span class="line"><span class="hljs-comment">&#125;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//  ./darknet [xxx]中如果命令如果第二个xxx参数是detector，则调用这个</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run_detector</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">char</span> *prefix = find_char_arg(argc, argv, <span class="hljs-string">"-prefix"</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">//寻找是否有参数prefix, 默认参数0，argv为二维数组，存储了参数字符串</span></span><br><span class="line">    <span class="hljs-keyword">float</span> thresh = find_float_arg(argc, argv, <span class="hljs-string">"-thresh"</span>, <span class="hljs-number">.5</span>);   <span class="hljs-comment">//寻找是否有参数thresh，thresh为输出的阈值,默认参数0.24</span></span><br><span class="line">    <span class="hljs-keyword">float</span> hier_thresh = find_float_arg(argc, argv, <span class="hljs-string">"-hier"</span>, <span class="hljs-number">.5</span>);    <span class="hljs-comment">//寻找是否有参数hier_thresh,默认0.5</span></span><br><span class="line">    <span class="hljs-keyword">int</span> cam_index = find_int_arg(argc, argv, <span class="hljs-string">"-c"</span>, <span class="hljs-number">0</span>);  <span class="hljs-comment">//寻找是否有参数c，默认0</span></span><br><span class="line">    <span class="hljs-keyword">int</span> frame_skip = find_int_arg(argc, argv, <span class="hljs-string">"-s"</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">//寻找是否有参数s，默认0</span></span><br><span class="line">    <span class="hljs-keyword">int</span> avg = find_int_arg(argc, argv, <span class="hljs-string">"-avg"</span>, <span class="hljs-number">3</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">//如果输入参数小于4个，输出正确语法如何使用</span></span><br><span class="line">    <span class="hljs-comment">//printf 等价于 fprintf(stdout, ...)，这里stderr和stdout默认输出设备都是屏幕，但是stderr一般指标准出错输入设备 </span></span><br><span class="line">    <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">4</span>)&#123;</span><br><span class="line">        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"usage: %s %s [train/test/valid] [cfg] [weights (optional)]\n"</span>, argv[<span class="hljs-number">0</span>], argv[<span class="hljs-number">1</span>]);</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">char</span> *gpu_list = find_char_arg(argc, argv, <span class="hljs-string">"-gpus"</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">//寻找是否有参数gpus，默认0</span></span><br><span class="line">    <span class="hljs-keyword">char</span> *outfile = find_char_arg(argc, argv, <span class="hljs-string">"-out"</span>, <span class="hljs-number">0</span>);   <span class="hljs-comment">//检查是否指定GPU运算,默认0</span></span><br><span class="line">    <span class="hljs-keyword">int</span> *gpus = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> gpu = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> ngpus = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span>(gpu_list)&#123;</span><br><span class="line">        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>, gpu_list);</span><br><span class="line">        <span class="hljs-keyword">int</span> len = <span class="hljs-built_in">strlen</span>(gpu_list);</span><br><span class="line">        ngpus = <span class="hljs-number">1</span>;</span><br><span class="line">        <span class="hljs-keyword">int</span> i;</span><br><span class="line">        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; len; ++i)&#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (gpu_list[i] == <span class="hljs-string">','</span>) ++ngpus;</span><br><span class="line">        &#125;</span><br><span class="line">        gpus = <span class="hljs-built_in">calloc</span>(ngpus, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));</span><br><span class="line">        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; ngpus; ++i)&#123;</span><br><span class="line">            gpus[i] = atoi(gpu_list);</span><br><span class="line">            gpu_list = <span class="hljs-built_in">strchr</span>(gpu_list, <span class="hljs-string">','</span>)+<span class="hljs-number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        gpu = gpu_index;</span><br><span class="line">        gpus = &amp;gpu;</span><br><span class="line">        ngpus = <span class="hljs-number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> clear = find_arg(argc, argv, <span class="hljs-string">"-clear"</span>); <span class="hljs-comment">//检查clear参数</span></span><br><span class="line">    <span class="hljs-keyword">int</span> fullscreen = find_arg(argc, argv, <span class="hljs-string">"-fullscreen"</span>);</span><br><span class="line">    <span class="hljs-keyword">int</span> width = find_int_arg(argc, argv, <span class="hljs-string">"-w"</span>, <span class="hljs-number">0</span>);</span><br><span class="line">    <span class="hljs-keyword">int</span> height = find_int_arg(argc, argv, <span class="hljs-string">"-h"</span>, <span class="hljs-number">0</span>);</span><br><span class="line">    <span class="hljs-keyword">int</span> fps = find_int_arg(argc, argv, <span class="hljs-string">"-fps"</span>, <span class="hljs-number">0</span>);</span><br><span class="line">    <span class="hljs-comment">//int class = find_int_arg(argc, argv, "-class", 0);</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">char</span> *datacfg = argv[<span class="hljs-number">3</span>];   <span class="hljs-comment">//存data文件路径</span></span><br><span class="line">    <span class="hljs-keyword">char</span> *cfg = argv[<span class="hljs-number">4</span>];    <span class="hljs-comment">//存cfg文件路径</span></span><br><span class="line">    <span class="hljs-keyword">char</span> *weights = (argc &gt; <span class="hljs-number">5</span>) ? argv[<span class="hljs-number">5</span>] : <span class="hljs-number">0</span>;   <span class="hljs-comment">//存weight文件路径</span></span><br><span class="line">    <span class="hljs-keyword">char</span> *filename = (argc &gt; <span class="hljs-number">6</span>) ? argv[<span class="hljs-number">6</span>]: <span class="hljs-number">0</span>;   <span class="hljs-comment">//存待检测文件路径</span></span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">//根据第三个参数的内容，调用不同的函数，并传入之前解析的参数</span></span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"test"</span>)) test_detector(datacfg, cfg, weights, filename, thresh, hier_thresh, outfile, fullscreen);</span><br><span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"train"</span>)) train_detector(datacfg, cfg, weights, gpus, ngpus, clear);</span><br><span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"valid"</span>)) validate_detector(datacfg, cfg, weights, outfile);</span><br><span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"valid2"</span>)) validate_detector_flip(datacfg, cfg, weights, outfile);</span><br><span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"recall"</span>)) validate_detector_recall(datacfg, cfg, weights);</span><br><span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>==<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"demo"</span>)) &#123;</span><br><span class="line">        <span class="hljs-built_in">list</span> *options = read_data_cfg(datacfg);</span><br><span class="line">        <span class="hljs-keyword">int</span> classes = option_find_int(options, <span class="hljs-string">"classes"</span>, <span class="hljs-number">20</span>);</span><br><span class="line">        <span class="hljs-keyword">char</span> *name_list = option_find_str(options, <span class="hljs-string">"names"</span>, <span class="hljs-string">"data/names.list"</span>);</span><br><span class="line">        <span class="hljs-keyword">char</span> **names = get_labels(name_list);</span><br><span class="line">        demo(cfg, weights, thresh, cam_index, filename, names, classes, frame_skip, prefix, avg, hier_thresh, width, height, fps, fullscreen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">//else if(0==strcmp(argv[2], "extract")) extract_detector(datacfg, cfg, weights, cam_index, filename, class, thresh, frame_skip);</span></span><br><span class="line">    <span class="hljs-comment">//else if(0==strcmp(argv[2], "censor")) censor_detector(datacfg, cfg, weights, cam_index, filename, class, thresh, frame_skip);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.cnblogs.com/xieqi/p/9818056.html" target="_blank" rel="noopener">YOLO-V3实战（darknet）</a></p>
<p><a href="https://www.jianshu.com/p/7ae10c8f7d77" target="_blank" rel="noopener">Darknet 评估训练好的网络的性能</a></p>
<p><a href="https://www.cnblogs.com/xieqi/p/9818056.html" target="_blank" rel="noopener">yolov3实战(darknet)</a></p>
<p><a href="https://github.com/pascal1129/yolo_person_detect" target="_blank" rel="noopener">yolo_person_detect</a></p>
<p><a href="https://github.com/AlexeyAB/darknet#how-to-train-to-detect-your-custom-objects" target="_blank" rel="noopener">Yolo-v3 and Yolo-v2 for Windows and Linux</a></p>
<p>[pjreddie/darknet](</p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/darknet/">darknet</a>, <a class="has-link-grey -link" href="/tags/deeplearning/">deeplearning</a>, <a class="has-link-grey -link" href="/tags/开源框架/">开源框架</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/post/c002250d.html">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">Markdown 记要</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/post/789284ab.html">
                <span class="level-item">目录-C/C++学习笔记</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>


</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/avatar.png" alt="水宇杰">
                    
                    
                    <p class="is-size-4 is-block">
                        水宇杰
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        从知道到做到
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Hangzhou</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        65
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        9
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        32
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="http://github.com/YujieShui" target="_blank">
                关注我</a>
        </div>
        
        
    </div>
</div>
    
        
<div class="card widget" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#数据集准备">
        <span class="has-mr-6">1</span>
        <span>数据集准备</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#labelimage">
        <span class="has-mr-6">1.1</span>
        <span>labelimage</span>
        </a></li><li>
        <a class="is-flex" href="#界面展示及注意事项">
        <span class="has-mr-6">1.2</span>
        <span>界面展示及注意事项</span>
        </a></li><li>
        <a class="is-flex" href="#快捷键">
        <span class="has-mr-6">1.3</span>
        <span>快捷键</span>
        </a></li><li>
        <a class="is-flex" href="#yolo格式和-xml-格式转换">
        <span class="has-mr-6">1.4</span>
        <span>yolo格式和 xml 格式转换</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#xml2yolo-py">
        <span class="has-mr-6">1.4.1</span>
        <span>xml2yolo.py</span>
        </a></li><li>
        <a class="is-flex" href="#yolo2xml-py">
        <span class="has-mr-6">1.4.2</span>
        <span>yolo2xml.py</span>
        </a></li></ul></li></ul></li><li>
        <a class="is-flex" href="#使用-darknet-训练模型">
        <span class="has-mr-6">2</span>
        <span>使用 darknet 训练模型</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#安装和编译">
        <span class="has-mr-6">2.1</span>
        <span>安装和编译</span>
        </a></li><li>
        <a class="is-flex" href="#目录结构介绍">
        <span class="has-mr-6">2.2</span>
        <span>目录结构介绍</span>
        </a></li><li>
        <a class="is-flex" href="#修改配置文件">
        <span class="has-mr-6">2.3</span>
        <span>修改配置文件</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#类别文件-voc-names">
        <span class="has-mr-6">2.3.1</span>
        <span>类别文件 voc.names</span>
        </a></li><li>
        <a class="is-flex" href="#配置-voc-data">
        <span class="has-mr-6">2.3.2</span>
        <span>配置 voc.data</span>
        </a></li><li>
        <a class="is-flex" href="#配置-yolov3-voc-cfg">
        <span class="has-mr-6">2.3.3</span>
        <span>配置 yolov3-voc.cfg</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#训练">
        <span class="has-mr-6">2.4</span>
        <span>训练</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#方法一">
        <span class="has-mr-6">2.4.1</span>
        <span>方法一</span>
        </a></li><li>
        <a class="is-flex" href="#方法二">
        <span class="has-mr-6">2.4.2</span>
        <span>方法二</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#查看-GPU-使用情况">
        <span class="has-mr-6">2.5</span>
        <span>查看 GPU 使用情况</span>
        </a></li><li>
        <a class="is-flex" href="#查看日志输出信息">
        <span class="has-mr-6">2.6</span>
        <span>查看日志输出信息</span>
        </a></li><li>
        <a class="is-flex" href="#测试">
        <span class="has-mr-6">2.7</span>
        <span>测试</span>
        </a></li><li>
        <a class="is-flex" href="#其他">
        <span class="has-mr-6">2.8</span>
        <span>其他</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#如何评估模型的效果">
        <span class="has-mr-6">3</span>
        <span>如何评估模型的效果</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#darknet-编译格式">
        <span class="has-mr-6">3.1</span>
        <span>darknet 编译格式</span>
        </a></li><li>
        <a class="is-flex" href="#根据训练日志生成-loss-iter-曲线">
        <span class="has-mr-6">3.2</span>
        <span>根据训练日志生成 loss-iter 曲线</span>
        </a></li><li>
        <a class="is-flex" href="#生成预测结果">
        <span class="has-mr-6">3.3</span>
        <span>生成预测结果</span>
        </a></li><li>
        <a class="is-flex" href="#统计召回率-recall">
        <span class="has-mr-6">3.4</span>
        <span>统计召回率 recall</span>
        </a></li><li>
        <a class="is-flex" href="#计算-mAP">
        <span class="has-mr-6">3.5</span>
        <span>计算 mAP</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#reval-voc-py">
        <span class="has-mr-6">3.5.1</span>
        <span>reval_voc.py</span>
        </a></li><li>
        <a class="is-flex" href="#voc-eval-py">
        <span class="has-mr-6">3.5.2</span>
        <span>voc_eval.py</span>
        </a></li><li>
        <a class="is-flex" href="#computer-Single-ALL-mAP-py">
        <span class="has-mr-6">3.5.3</span>
        <span>computer_Single_ALL_mAP.py</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#detector-c">
        <span class="has-mr-6">3.6</span>
        <span>detector.c</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#参考">
        <span class="has-mr-6">4</span>
        <span>参考</span>
        </a></li></ul>
        </div>
    </div>
</div>

    
        

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/C-C/">
            <span class="level-start">
                <span class="level-item">C/C++</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">26</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/DeepLearning/">
            <span class="level-start">
                <span class="level-item">DeepLearning</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">10</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Linux/">
            <span class="level-start">
                <span class="level-item">Linux</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/OpenCV/">
            <span class="level-start">
                <span class="level-item">OpenCV</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Python/">
            <span class="level-start">
                <span class="level-item">Python</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/分布式/">
            <span class="level-start">
                <span class="level-item">分布式</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/图像处理/">
            <span class="level-start">
                <span class="level-item">图像处理</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/工具癖/">
            <span class="level-start">
                <span class="level-item">工具癖</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/RocketMQ/" style="font-size: 11.43px;">RocketMQ</a> <a href="/tags/anaconda/" style="font-size: 10px;">anaconda</a> <a href="/tags/c/" style="font-size: 18.57px;">c</a> <a href="/tags/c/" style="font-size: 20px;">c++</a> <a href="/tags/caffe/" style="font-size: 10px;">caffe</a> <a href="/tags/darknet/" style="font-size: 10px;">darknet</a> <a href="/tags/deeplearning/" style="font-size: 11.43px;">deeplearning</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/java/" style="font-size: 18.57px;">java</a> <a href="/tags/linux/" style="font-size: 17.14px;">linux</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/mybatis/" style="font-size: 10px;">mybatis</a> <a href="/tags/numpy/" style="font-size: 10px;">numpy</a> <a href="/tags/opencv/" style="font-size: 15.71px;">opencv</a> <a href="/tags/protobuf/" style="font-size: 10px;">protobuf</a> <a href="/tags/python/" style="font-size: 14.29px;">python</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/springboot/" style="font-size: 12.86px;">springboot</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/stl/" style="font-size: 18.57px;">stl</a> <a href="/tags/ubuntu/" style="font-size: 11.43px;">ubuntu</a> <a href="/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/tags/分布式/" style="font-size: 11.43px;">分布式</a> <a href="/tags/图像处理/" style="font-size: 11.43px;">图像处理</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/并发编程/" style="font-size: 11.43px;">并发编程</a> <a href="/tags/开源框架/" style="font-size: 11.43px;">开源框架</a> <a href="/tags/消息队列/" style="font-size: 12.86px;">消息队列</a> <a href="/tags/网站/" style="font-size: 10px;">网站</a>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-07-21T14:22:05.000Z">2019-07-21</time></div>
                    <a href="/post/92782b0b.html" class="has-link-black-ter is-size-6">学习shell编程</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-29T15:39:03.000Z">2019-06-29</time></div>
                    <a href="/post/87698413.html" class="has-link-black-ter is-size-6">Linux进程</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-23T13:50:14.000Z">2019-06-23</time></div>
                    <a href="/post/d907dbe2.html" class="has-link-black-ter is-size-6">Python参考书籍</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Python/">Python</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-20T14:21:17.000Z">2019-06-20</time></div>
                    <a href="/post/6dde8c87.html" class="has-link-black-ter is-size-6">PEP8风格指南</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Python/">Python</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-17T10:21:53.000Z">2019-06-17</time></div>
                    <a href="/post/96cd1245.html" class="has-link-black-ter is-size-6">【Caffe】Caffe实战手写数字分类</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/DeepLearning/">DeepLearning</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">21</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">17</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/03/">
                <span class="level-start">
                    <span class="level-item">三月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/02/">
                <span class="level-start">
                    <span class="level-item">二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/02/">
                <span class="level-start">
                    <span class="level-item">二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MQ/">
                        <span class="tag">MQ</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/RabbitMQ/">
                        <span class="tag">RabbitMQ</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/RocketMQ/">
                        <span class="tag">RocketMQ</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/anaconda/">
                        <span class="tag">anaconda</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/c/">
                        <span class="tag">c</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/c/">
                        <span class="tag">c++</span>
                        <span class="tag is-grey">22</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/caffe/">
                        <span class="tag">caffe</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/darknet/">
                        <span class="tag">darknet</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/deeplearning/">
                        <span class="tag">deeplearning</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/docker/">
                        <span class="tag">docker</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/java/">
                        <span class="tag">java</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/linux/">
                        <span class="tag">linux</span>
                        <span class="tag is-grey">9</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/markdown/">
                        <span class="tag">markdown</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/maven/">
                        <span class="tag">maven</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/mybatis/">
                        <span class="tag">mybatis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/numpy/">
                        <span class="tag">numpy</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/opencv/">
                        <span class="tag">opencv</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/protobuf/">
                        <span class="tag">protobuf</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/python/">
                        <span class="tag">python</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/shell/">
                        <span class="tag">shell</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/springboot/">
                        <span class="tag">springboot</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ssh/">
                        <span class="tag">ssh</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/stl/">
                        <span class="tag">stl</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ubuntu/">
                        <span class="tag">ubuntu</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/zookeeper/">
                        <span class="tag">zookeeper</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分布式/">
                        <span class="tag">分布式</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/图像处理/">
                        <span class="tag">图像处理</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工具/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发编程/">
                        <span class="tag">并发编程</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源框架/">
                        <span class="tag">开源框架</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/消息队列/">
                        <span class="tag">消息队列</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/网站/">
                        <span class="tag">网站</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-07-21T14:22:05.000Z">2019-07-21</time></div>
                    <a href="/post/92782b0b.html" class="has-link-black-ter is-size-6">学习shell编程</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-29T15:39:03.000Z">2019-06-29</time></div>
                    <a href="/post/87698413.html" class="has-link-black-ter is-size-6">Linux进程</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-23T13:50:14.000Z">2019-06-23</time></div>
                    <a href="/post/d907dbe2.html" class="has-link-black-ter is-size-6">Python参考书籍</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Python/">Python</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-20T14:21:17.000Z">2019-06-20</time></div>
                    <a href="/post/6dde8c87.html" class="has-link-black-ter is-size-6">PEP8风格指南</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Python/">Python</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-06-17T10:21:53.000Z">2019-06-17</time></div>
                    <a href="/post/96cd1245.html" class="has-link-black-ter is-size-6">【Caffe】Caffe实战手写数字分类</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/DeepLearning/">DeepLearning</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">21</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">17</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/03/">
                <span class="level-start">
                    <span class="level-item">三月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/02/">
                <span class="level-start">
                    <span class="level-item">二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/02/">
                <span class="level-start">
                    <span class="level-item">二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MQ/">
                        <span class="tag">MQ</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/RabbitMQ/">
                        <span class="tag">RabbitMQ</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/RocketMQ/">
                        <span class="tag">RocketMQ</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/anaconda/">
                        <span class="tag">anaconda</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/c/">
                        <span class="tag">c</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/c/">
                        <span class="tag">c++</span>
                        <span class="tag is-grey">22</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/caffe/">
                        <span class="tag">caffe</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/darknet/">
                        <span class="tag">darknet</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/deeplearning/">
                        <span class="tag">deeplearning</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/docker/">
                        <span class="tag">docker</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/java/">
                        <span class="tag">java</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/linux/">
                        <span class="tag">linux</span>
                        <span class="tag is-grey">9</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/markdown/">
                        <span class="tag">markdown</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/maven/">
                        <span class="tag">maven</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/mybatis/">
                        <span class="tag">mybatis</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/numpy/">
                        <span class="tag">numpy</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/opencv/">
                        <span class="tag">opencv</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/protobuf/">
                        <span class="tag">protobuf</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/python/">
                        <span class="tag">python</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/shell/">
                        <span class="tag">shell</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/springboot/">
                        <span class="tag">springboot</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ssh/">
                        <span class="tag">ssh</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/stl/">
                        <span class="tag">stl</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ubuntu/">
                        <span class="tag">ubuntu</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/zookeeper/">
                        <span class="tag">zookeeper</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/分布式/">
                        <span class="tag">分布式</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/图像处理/">
                        <span class="tag">图像处理</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/工具/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/并发编程/">
                        <span class="tag">并发编程</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/开源框架/">
                        <span class="tag">开源框架</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/消息队列/">
                        <span class="tag">消息队列</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/网站/">
                        <span class="tag">网站</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="【darknet】darknet实战" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 深页&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>